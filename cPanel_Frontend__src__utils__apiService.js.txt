// A function to get the current token from Local Storage
const getToken = () => localStorage.getItem("calcpro-admin-token");

// A function to handle the automatic logout process
const handleUnauthorized = () => {
  // Clear the stored user and token
  localStorage.removeItem("calcpro-admin-user");
  localStorage.removeItem("calcpro-admin-token");
  // Redirect to the login page. The AuthContext and Router will handle the rest.
  window.location.hash = "/admin/login";
};

/**
 * A centralized function for making authenticated API calls.
 * It automatically adds the JWT header, handles 401 errors, and dispatches an
 * activity event to reset the inactivity timer.
 *
 * @param {string} url The API endpoint URL to call.
 * @param {object} options The options for the fetch request (e.g., method, body).
 * @returns {Promise<object>} The JSON response from the API.
 */
export const authenticatedFetch = async (url, options = {}) => {
  const token = getToken();

  // Prepare the headers, merging any custom headers with our standard ones
  const headers = {
    "Content-Type": "application/json",
    ...options.headers, // Allow custom headers to be passed in
  };

  if (token) {
    headers["Authorization"] = `Bearer ${token}`;
  }

  try {
    const response = await fetch(url, { ...options, headers });

    // If the server responds with 401 Unauthorized, the token is invalid or expired.
    if (response.status === 401) {
      handleUnauthorized();
      // We throw an error to stop further processing in the calling component
      throw new Error("Unauthorized");
    }

    if (!response.ok) {
      // For other non-successful responses, try to parse the error message
      const errorResult = await response.json();
      throw new Error(
        errorResult.message || `HTTP error! status: ${response.status}`
      );
    }

    // --- THIS IS THE NEW LOGIC ---
    // If the API call was successful, dispatch a custom event to signal user activity.
    // The AuthContext is listening for this event and will reset the inactivity timer.
    window.dispatchEvent(new CustomEvent("user-activity"));
    // --- END OF NEW LOGIC ---

    return await response.json();
  } catch (error) {
    // Re-throw the error so the calling component can handle it if needed.
    // We avoid console logging "Unauthorized" as it's an expected flow, not a bug.
    if (error.message !== "Unauthorized") {
      console.error("API call failed:", error.message);
    }
    throw error;
  }
};