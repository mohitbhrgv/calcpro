<?php
// Use robust, absolute paths
require_once dirname(__DIR__, 2) . '/core/config.php';
require_once dirname(__DIR__, 2) . '/core/response.php';

try {
    // --- 1. Get Incoming Data ---
    $json = file_get_contents('php://input');
    $data = json_decode($json);

    // --- 2. Validation ---
    if (!isset($data->token) || empty($data->token)) {
        sendResponse(false, null, 'A valid reset token is required.', 400, 'INVALID_INPUT');
    }
    if (!isset($data->password) || empty($data->password)) {
        sendResponse(false, null, 'A new password is required.', 400, 'INVALID_INPUT');
    }

    // --- 3. Server-Side Password Strength Validation ---
    if (!validatePasswordStrength($data->password)) {
        sendResponse(false, null, 'Password must be at least 8 characters and include a letter, a number, and a symbol.', 400, 'WEAK_PASSWORD');
    }

    // --- 4. Sanitize and Prepare Data ---
    $token = $data->token;
    $new_password = $data->password;
    $token_hash = hash('sha256', $token);

    // --- 5. Find User by Token and Check Expiry ---
    $sql_find = "SELECT id, reset_token_expires_at FROM admins WHERE reset_token = ?";
    $stmt_find = $conn->prepare($sql_find);
    $stmt_find->bind_param("s", $token_hash);
    $stmt_find->execute();
    $result = $stmt_find->get_result();
    
    if ($result->num_rows === 0) {
        $stmt_find->close();
        sendResponse(false, null, 'This password reset link is invalid. Please try again.', 400, 'INVALID_TOKEN');
    }

    $admin = $result->fetch_assoc();
    $stmt_find->close();

    // Check if the token has expired
    if (strtotime($admin['reset_token_expires_at']) < time()) {
        sendResponse(false, null, 'This password reset link has expired. Please request a new one.', 400, 'EXPIRED_TOKEN');
    }

    // --- 6. THIS IS THE FIX: Update Password AND Invalidate Token ---
    $new_hashed_password = password_hash($new_password, PASSWORD_BCRYPT);
    
    // The SQL query is updated to set the token fields to NULL.
    $sql_update = "UPDATE admins SET password = ?, reset_token = NULL, reset_token_expires_at = NULL WHERE id = ?";
    $stmt_update = $conn->prepare($sql_update);
    // The bind_param remains the same ("si") because we are setting to NULL directly in the query.
    $stmt_update->bind_param("si", $new_hashed_password, $admin['id']);

    if ($stmt_update->execute()) {
        sendResponse(true, null, 'Password has been reset successfully. You can now log in.');
    } else {
        throw new Exception("Database password update failed: " . $stmt_update->error);
    }
    $stmt_update->close();
    // --- END OF FIX ---

} catch (Exception $e) {
    error_log("Error in reset_admin_password.php: " . $e->getMessage());
    sendResponse(false, null, 'An internal server error occurred.', 500, 'SERVER_ERROR');
}

$conn->close();