import React, { useState, useEffect, useCallback, useRef } from "react";
import { useNavigate } from "react-router-dom";
import { useAuth } from "../../context/AuthContext";
import { useTheme } from "../../context/ThemeContext";
import { motion, AnimatePresence } from "framer-motion";
import SafeIcon from "../../../common/SafeIcon";
import { authenticatedFetch } from "../../utils/apiService";
import * as FiIcons from "react-icons/fi";
import * as IoIcons from "react-icons/io5";
import * as HiIcons from "react-icons/hi";
import toast from "react-hot-toast";
import EditProfileModal from "../auth/EditProfileModal";

const Header = () => {
  const { user, logout } = useAuth();
  const { isDark, toggleTheme } = useTheme();
  const navigate = useNavigate();
  
  const [showUserMenu, setShowUserMenu] = useState(false);
  const [showNotifications, setShowNotifications] = useState(false);
  const [isProfileModalOpen, setIsProfileModalOpen] = useState(false);

  // --- Refs for Click Outside Logic ---
  const notificationRef = useRef(null);
  const notificationBtnRef = useRef(null);
  const userMenuRef = useRef(null);
  const userMenuBtnRef = useRef(null);

  // --- Live Data States ---
  const [notifications, setNotifications] = useState([]);
  const [unreadCount, setUnreadCount] = useState(0);
  
  // --- New UI States ---
  const [viewAll, setViewAll] = useState(false); // Controls 3 items vs full list
  const lastNotifIdRef = useRef(0);

  // --- 1. Fetch Notifications Logic ---
  const fetchNotifications = useCallback(async (isPolling = false) => {
    try {
      const result = await authenticatedFetch(
        "http://localhost/calcpro-api/api/admin/get_notifications.php"
      );
      if (result.success) {
        const newNotifs = result.data.notifications;
        
        // On-Screen Alert Logic
        if (isPolling && newNotifs.length > 0) {
            const latestId = newNotifs[0].id;
            if (latestId > lastNotifIdRef.current) {
                const newItems = newNotifs.filter(n => n.id > lastNotifIdRef.current);
                if(newItems.length > 0) {
                     // --- UPDATED: Blue Theme & Longer Duration ---
                     toast.custom((t) => (
                        <div className={`${t.visible ? 'animate-enter' : 'animate-leave'} max-w-md w-full bg-blue-600 dark:bg-blue-700 shadow-xl rounded-lg pointer-events-auto flex ring-1 ring-black ring-opacity-5 border-l-4 border-white`}>
                          <div className="flex-1 w-0 p-4">
                            <div className="flex items-start">
                              <div className="ml-3 flex-1">
                                <p className="text-sm font-bold text-white">
                                  {newItems[0].title}
                                </p>
                                <p className="mt-1 text-sm text-blue-100">
                                  {newItems[0].message}
                                </p>
                              </div>
                            </div>
                          </div>
                          <div className="flex border-l border-blue-500">
                            <button
                              onClick={() => { setShowNotifications(true); toast.dismiss(t.id); }}
                              className="w-full border border-transparent rounded-none rounded-r-lg p-4 flex items-center justify-center text-sm font-medium text-white hover:bg-blue-700 focus:outline-none transition-colors"
                            >
                              View
                            </button>
                          </div>
                        </div>
                     ), { duration: 8000, position: "bottom-right" });
                }
            }
        }
        
        if (newNotifs.length > 0) {
            lastNotifIdRef.current = newNotifs[0].id;
        }

        setNotifications(newNotifs);
        setUnreadCount(result.data.unreadCount);
      }
    } catch (error) {
      console.error("Notification polling failed", error);
    }
  }, []);

  // --- 2. Poll Every 30 Seconds ---
  useEffect(() => {
    fetchNotifications(false);
    const interval = setInterval(() => fetchNotifications(true), 30000);
    return () => clearInterval(interval);
  }, [fetchNotifications]);

  // --- 3. Click Outside Handler ---
  useEffect(() => {
    const handleClickOutside = (event) => {
      // Close Notifications
      if (
        showNotifications &&
        notificationRef.current &&
        !notificationRef.current.contains(event.target) &&
        !notificationBtnRef.current.contains(event.target)
      ) {
        setShowNotifications(false);
      }

      // Close User Menu
      if (
        showUserMenu &&
        userMenuRef.current &&
        !userMenuRef.current.contains(event.target) &&
        !userMenuBtnRef.current.contains(event.target)
      ) {
        setShowUserMenu(false);
      }
    };

    document.addEventListener("mousedown", handleClickOutside);
    return () => document.removeEventListener("mousedown", handleClickOutside);
  }, [showNotifications, showUserMenu]);


  // --- 4. Grouping Helper (Date-based) ---
  const getGroupedNotifications = () => {
    // If not "View All", only take top 3
    const visibleList = viewAll ? notifications : notifications.slice(0, 3);
    
    const groups = {};
    const today = new Date().toDateString();
    const yesterday = new Date(Date.now() - 86400000).toDateString();

    visibleList.forEach(note => {
        const noteDate = new Date(note.created_at).toDateString();
        let key = noteDate;
        
        if (noteDate === today) key = "Today";
        else if (noteDate === yesterday) key = "Yesterday";
        else key = new Date(note.created_at).toLocaleDateString(undefined, { month: 'short', day: 'numeric', year: 'numeric' });

        if (!groups[key]) groups[key] = [];
        groups[key].push(note);
    });
    
    return groups;
  };

  const groupedNotifications = getGroupedNotifications();

  // --- 5. Action Handlers ---
  const handleMarkAllAsRead = async () => {
    setNotifications((prev) => prev.map((n) => ({ ...n, read: true })));
    setUnreadCount(0);
    try {
      await authenticatedFetch("http://localhost/calcpro-api/api/admin/mark_notification_read.php", {
        method: "POST",
        body: JSON.stringify({ mark_all: true }),
      });
    } catch (error) { console.error(error); }
  };

  const handleDelete = async (e, id) => {
      e.stopPropagation(); 
      setNotifications(prev => prev.filter(n => n.id !== id)); 
      try {
        await authenticatedFetch("http://localhost/calcpro-api/api/admin/delete_notification.php", {
            method: "POST",
            body: JSON.stringify({ id }),
        });
      } catch (error) { console.error(error); }
  };

  const handleDeleteAll = async () => {
      if(!window.confirm("Are you sure you want to clear all notifications?")) return;
      setNotifications([]);
      setUnreadCount(0);
      try {
        await authenticatedFetch("http://localhost/calcpro-api/api/admin/delete_notification.php", {
            method: "POST",
            body: JSON.stringify({ delete_all: true }),
        });
      } catch (error) { console.error(error); }
  };

  const handleNotificationClick = async (notification) => {
    if (notification.link) {
      navigate(notification.link);
      setShowNotifications(false);
      
      // --- UPDATED: Dispatch event to force data refresh on target pages ---
      if (notification.link.includes('security') || notification.link.includes('brute-force')) {
          // Small delay to allow navigation to complete
          setTimeout(() => window.dispatchEvent(new Event('security-data-update')), 50);
      }
      if (notification.link.includes('users')) {
          setTimeout(() => window.dispatchEvent(new Event('user-data-update')), 50);
      }
    }
    
    if (!notification.read) {
      setNotifications((prev) => prev.map((n) => (n.id === notification.id ? { ...n, read: true } : n)));
      setUnreadCount((prev) => Math.max(0, prev - 1));
      try {
        await authenticatedFetch("http://localhost/calcpro-api/api/admin/mark_notification_read.php", {
          method: "POST",
          body: JSON.stringify({ id: notification.id }),
        });
      } catch (error) { console.error(error); }
    }
  };

  // --- 6. Styling Helpers ---
  const getNotificationIcon = (type) => {
    switch (type) {
      case "user": return HiIcons.HiOutlineUserAdd;
      case "security": return IoIcons.IoShieldCheckmarkOutline;
      case "milestone": return IoIcons.IoTrophyOutline;
      case "system": default: return IoIcons.IoNotificationsOutline;
    }
  };

  const getNotificationColor = (type, severity) => {
    if (type === "security" && severity === "critical") return "bg-red-100 text-red-600 dark:bg-red-900/30 dark:text-red-400";
    if (severity === "warning") return "bg-amber-100 text-amber-600 dark:bg-amber-900/30 dark:text-amber-400";
    switch (type) {
      case "user": return "bg-blue-100 text-blue-600 dark:bg-blue-900/30 dark:text-blue-400";
      case "milestone": return "bg-purple-100 text-purple-600 dark:bg-purple-900/30 dark:text-purple-400";
      case "security": return "bg-orange-100 text-orange-600 dark:bg-orange-900/30 dark:text-orange-400";
      default: return "bg-gray-100 text-gray-600 dark:bg-gray-700 dark:text-gray-400";
    }
  };

  return (
    <>
      <EditProfileModal isOpen={isProfileModalOpen} onClose={() => setIsProfileModalOpen(false)} />

      <header className="bg-white dark:bg-gray-800 shadow-sm border-b border-gray-200 dark:border-gray-700 sticky top-0 z-40">
        <div className="flex items-center justify-end px-6 py-4">
          <div className="flex items-center space-x-2 md:space-x-4">
            
            <motion.button
              whileHover={{ scale: 1.05 }}
              whileTap={{ scale: 0.95 }}
              onClick={toggleTheme}
              className="p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors"
            >
              <SafeIcon icon={isDark ? IoIcons.IoSunnyOutline : IoIcons.IoMoonOutline} className="w-5 h-5 text-gray-600 dark:text-gray-300" />
            </motion.button>

            {/* Notifications */}
            <div className="relative">
              <motion.button
                ref={notificationBtnRef}
                whileHover={{ scale: 1.05 }}
                whileTap={{ scale: 0.95 }}
                onClick={() => { setShowNotifications(!showNotifications); if (showUserMenu) setShowUserMenu(false); }}
                className="p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors relative"
              >
                <SafeIcon icon={IoIcons.IoNotificationsOutline} className="w-5 h-5 text-gray-600 dark:text-gray-300" />
                {unreadCount > 0 && (
                  <span className="absolute -top-1 -right-1 flex h-5 w-5">
                    <span className="animate-ping absolute inline-flex h-full w-full rounded-full bg-red-400 opacity-75"></span>
                    <span className="relative inline-flex rounded-full h-5 w-5 bg-red-500 text-xs text-white items-center justify-center font-bold">
                      {unreadCount > 9 ? "9+" : unreadCount}
                    </span>
                  </span>
                )}
              </motion.button>

              <AnimatePresence>
                {showNotifications && (
                  <motion.div
                    ref={notificationRef}
                    initial={{ opacity: 0, y: 10 }}
                    animate={{ opacity: 1, y: 0 }}
                    exit={{ opacity: 0, y: 10 }}
                    className="absolute right-0 mt-2 w-80 sm:w-96 bg-white dark:bg-gray-800 rounded-xl shadow-xl border border-gray-200 dark:border-gray-700 z-50 overflow-hidden flex flex-col"
                    style={{ maxHeight: viewAll ? '80vh' : 'auto' }}
                  >
                    {/* Header */}
                    <div className="p-4 border-b border-gray-200 dark:border-gray-700 flex justify-between items-center bg-gray-50 dark:bg-gray-700/30 shrink-0">
                      <div className="flex items-center gap-2">
                          <h3 className="font-bold text-gray-900 dark:text-white">Notifications</h3>
                          {notifications.length > 0 && (
                              <span className="bg-gray-200 dark:bg-gray-600 text-gray-700 dark:text-gray-300 px-2 py-0.5 rounded-full text-xs font-bold">{notifications.length}</span>
                          )}
                      </div>
                      <div className="flex gap-3">
                          {unreadCount > 0 && (
                            <button onClick={handleMarkAllAsRead} className="text-xs text-blue-600 dark:text-blue-400 hover:underline font-medium">Mark read</button>
                          )}
                          {notifications.length > 0 && (
                            <button onClick={handleDeleteAll} className="text-xs text-red-600 dark:text-red-400 hover:underline font-medium">Clear all</button>
                          )}
                      </div>
                    </div>
                    
                    {/* Body - Scrollable only if viewAll is true */}
                    <div className={`overflow-y-auto custom-scrollbar ${viewAll ? 'max-h-[24rem]' : 'max-h-auto'}`}>
                      {notifications.length === 0 ? (
                        <div className="p-8 text-center text-gray-500 dark:text-gray-400">
                           <SafeIcon icon={IoIcons.IoNotificationsOffOutline} className="w-8 h-8 mx-auto mb-2 opacity-50" />
                           <p className="text-sm">No notifications yet.</p>
                        </div>
                      ) : (
                        // Group Render
                        Object.entries(groupedNotifications).map(([dateLabel, groupNotes]) => (
                            <div key={dateLabel}>
                                <div className="px-4 py-1.5 bg-gray-50 dark:bg-gray-700/50 border-y border-gray-100 dark:border-gray-700 text-[10px] font-bold text-gray-500 dark:text-gray-400 uppercase tracking-wider sticky top-0 backdrop-blur-sm z-10">
                                    {dateLabel}
                                </div>
                                {groupNotes.map((notification) => (
                                    <div
                                        key={notification.id}
                                        onClick={() => handleNotificationClick(notification)}
                                        className={`group relative p-4 border-b border-gray-100 dark:border-gray-700 last:border-0 cursor-pointer transition-colors hover:bg-gray-50 dark:hover:bg-gray-700/50 ${!notification.read ? "bg-blue-50/50 dark:bg-blue-900/10" : ""}`}
                                    >
                                        <div className="flex items-start space-x-3">
                                            <div className={`p-2 rounded-lg shrink-0 ${getNotificationColor(notification.type, notification.severity)}`}>
                                                <SafeIcon icon={getNotificationIcon(notification.type)} className="w-5 h-5" />
                                            </div>
                                            <div className="flex-1 min-w-0 pr-6">
                                                <div className="flex justify-between items-start">
                                                    <p className={`text-sm ${!notification.read ? "font-bold" : "font-medium"} text-gray-900 dark:text-white truncate`}>
                                                        {notification.title}
                                                    </p>
                                                    <span className="text-[10px] text-gray-400 dark:text-gray-500 whitespace-nowrap ml-2">
                                                        {notification.time}
                                                    </span>
                                                </div>
                                                <p className="text-xs text-gray-600 dark:text-gray-300 mt-1 line-clamp-2">
                                                    {notification.message}
                                                </p>
                                            </div>
                                            {!notification.read && <span className="absolute right-4 top-5 w-2 h-2 bg-blue-600 rounded-full"></span>}
                                            
                                            <button 
                                                onClick={(e) => handleDelete(e, notification.id)}
                                                className="absolute right-2 bottom-2 p-1.5 text-gray-400 hover:text-red-500 hover:bg-red-50 dark:hover:bg-red-900/20 rounded-md opacity-0 group-hover:opacity-100 transition-all"
                                                title="Delete"
                                            >
                                                <SafeIcon icon={FiIcons.FiTrash2} className="w-3.5 h-3.5" />
                                            </button>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        ))
                      )}
                    </div>

                    {/* Footer */}
                    {notifications.length > 3 && (
                        <div className="p-0 border-t border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-gray-700/30 shrink-0">
                            <button 
                                className="w-full py-3 text-xs text-indigo-600 dark:text-indigo-400 font-bold flex items-center justify-center gap-1 hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors"
                                onClick={() => setViewAll(!viewAll)}
                            >
                                {viewAll ? "Show Less" : "View All Notifications"}
                                <SafeIcon icon={viewAll ? FiIcons.FiChevronUp : FiIcons.FiChevronDown} className="w-3 h-3" />
                            </button>
                        </div>
                    )}
                  </motion.div>
                )}
              </AnimatePresence>
            </div>

            {/* Profile Dropdown */}
            <div className="relative">
              <motion.button
                ref={userMenuBtnRef}
                whileHover={{ scale: 1.05 }}
                whileTap={{ scale: 0.95 }}
                onClick={() => {
                  setShowUserMenu(!showUserMenu);
                  if (showNotifications) setShowNotifications(false);
                }}
                className="flex items-center space-x-3 p-1.5 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors"
              >
                <div className="relative">
                  <img
                    src={user?.avatar || `https://ui-avatars.com/api/?name=${user?.name.replace(/\s/g,"+")}&background=3949ab&color=fff`}
                    alt={user?.name}
                    className="w-8 h-8 rounded-full border-2 border-white dark:border-gray-700 shadow-sm"
                  />
                  <span className="absolute bottom-0 right-0 w-2.5 h-2.5 bg-green-500 rounded-full border-2 border-white dark:border-gray-700"></span>
                </div>
                <span className="hidden md:inline-block text-sm font-medium text-gray-700 dark:text-gray-300">
                  {user?.name}
                </span>
                <SafeIcon icon={FiIcons.FiChevronDown} className="w-4 h-4 text-gray-500 hidden md:inline-block" />
              </motion.button>

              <AnimatePresence>
                {showUserMenu && (
                  <motion.div
                    ref={userMenuRef}
                    initial={{ opacity: 0, y: 10 }}
                    animate={{ opacity: 1, y: 0 }}
                    exit={{ opacity: 0, y: 10 }}
                    className="absolute right-0 mt-2 w-56 bg-white dark:bg-gray-800 rounded-xl shadow-lg border border-gray-200 dark:border-gray-700 z-50 overflow-hidden"
                  >
                    <div className="p-4 border-b border-gray-200 dark:border-gray-700">
                      <div className="flex items-center space-x-3">
                        <img
                          src={user?.avatar || `https://ui-avatars.com/api/?name=${user?.name.replace(/\s/g,"+")}&background=3949ab&color=fff`}
                          alt={user?.name}
                          className="w-10 h-10 rounded-full"
                        />
                        <div className="min-w-0">
                          <h3 className="font-medium text-gray-900 dark:text-white truncate">{user?.name}</h3>
                          <p className="text-xs text-gray-500 dark:text-gray-400 truncate">{user?.email}</p>
                        </div>
                      </div>
                    </div>
                    <div className="py-2">
                      <button onClick={() => { setIsProfileModalOpen(true); setShowUserMenu(false); }} className="flex items-center space-x-3 w-full px-4 py-2.5 text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700">
                        <SafeIcon icon={HiIcons.HiOutlinePencilAlt} className="w-4 h-4" />
                        <span>Edit Profile</span>
                      </button>
                      <div className="border-t border-gray-200 dark:border-gray-700 my-1"></div>
                      <button onClick={() => logout("You have logged out successfully.")} className="flex items-center space-x-3 w-full px-4 py-2.5 text-sm text-red-600 hover:bg-red-50 dark:hover:bg-red-900/10 transition-colors">
                        <SafeIcon icon={IoIcons.IoLogOutOutline} className="w-4 h-4" />
                        <span>Logout</span>
                      </button>
                    </div>
                  </motion.div>
                )}
              </AnimatePresence>
            </div>
          </div>
        </div>
      </header>
    </>
  );
};

export default Header;