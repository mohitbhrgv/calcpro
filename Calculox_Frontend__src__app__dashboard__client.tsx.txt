"use client";

import React, { useState, useEffect } from "react";
import Link from "next/link";
import { useRouter, useSearchParams } from "next/navigation";
import { motion, AnimatePresence } from "framer-motion";
import { useAuth } from "@/context/AuthContext";
import toast from "react-hot-toast";
import SafeIcon from "@/components/common/SafeIcon";
import * as FiIcons from "react-icons/fi";
import { fetchAPI } from "@/services/api";
import { calculatorData, CalculatorItem } from "@/data/calculatorData";
import { validatePassword } from "@/utils/passwordValidator";

const {
  FiUser, FiSettings, FiLogOut, FiBookmark, FiClock,
  FiStar, FiTrash2, FiBarChart2, FiCalculator, 
  FiEdit3, FiMail, FiLock, FiTrash, FiXCircle,
  FiCheckCircle, FiAlertCircle, FiCalendar, FiCheck, FiSave
} = FiIcons;

interface Calculation {
  id: number;
  calculator_type: string;
  inputs: any;
  results: any;
  created_at: string;
}

const ClientDashboard = () => {
  const { user, logout, login, isLoading } = useAuth();
  const router = useRouter();
  const searchParams = useSearchParams();

  // --- State Management ---
  const [activeTab, setActiveTab] = useState("overview");
  const [calculations, setCalculations] = useState<Calculation[]>([]);
  const [isLoadingHistory, setIsLoadingHistory] = useState(false);
  const [bookmarkedCalculators, setBookmarkedCalculators] = useState<CalculatorItem[]>([]);
  const [isLoadingBookmarks, setIsLoadingBookmarks] = useState(false);
  
  const [formData, setFormData] = useState({
    name: "",
    email: "",
    currentPassword: "",
    newPassword: "",
    confirmPassword: "",
  });
  const [isSubmittingProfile, setIsSubmittingProfile] = useState(false);
  const [isSubmittingPassword, setIsSubmittingPassword] = useState(false);
  const [welcomeMessage, setWelcomeMessage] = useState("");

  // --- 1. Auth Guard & Initialization ---
  useEffect(() => {
    // Only run logic once loading is finished
    if (!isLoading) {
      if (!user) {
        router.push("/login");
        return;
      }

      // Safe to set form data now
      setFormData((prev) => ({ 
        ...prev, 
        name: user.name || "", 
        email: user.email || "" 
      }));
      
      const isFirstLogin = sessionStorage.getItem("is_first_login");
      if (isFirstLogin) {
        setWelcomeMessage(`Welcome, ${user.name}! Your account is now active.`);
      } else {
        setWelcomeMessage(`Welcome back, ${user.name}!`);
      }
    }
  }, [user, isLoading, router]);

  // --- 2. URL Tab Sync ---
  useEffect(() => {
    const tabParam = searchParams.get("tab");
    if (tabParam && ["overview", "calculations", "bookmarks", "settings"].includes(tabParam)) {
      setActiveTab(tabParam);
    }
  }, [searchParams]);

  // --- 3. Data Fetching ---
  useEffect(() => {
    if (!user || !user.id) return;

    const fetchCalculations = async () => {
      setIsLoadingHistory(true);
      try {
        const data = await fetchAPI(`/public/get_calculations.php?userId=${user.id}`, { cache: 'no-store' });
        if (data.success) {
          setCalculations(data.calculations);
        } else {
          // Silent error or toast depending on preference
        }
      } catch (error) {
        console.error("History fetch error:", error);
      } finally {
        setIsLoadingHistory(false);
      }
    };

    const fetchBookmarks = async () => {
      setIsLoadingBookmarks(true);
      try {
        const data = await fetchAPI(`/public/get_bookmarks.php?userId=${user.id}`, { cache: 'no-store' });
        if (data.success) {
          const filteredBookmarks = calculatorData.filter((calc) =>
            data.bookmarks.includes(calc.id)
          );
          setBookmarkedCalculators(filteredBookmarks);
        }
      } catch (error) {
        console.error("Bookmark fetch error:", error);
      } finally {
        setIsLoadingBookmarks(false);
      }
    };

    if (activeTab === "calculations") fetchCalculations();
    if (activeTab === "bookmarks") fetchBookmarks();
    if (activeTab === "overview") {
      fetchCalculations();
      fetchBookmarks();
    }
  }, [activeTab, user]);

  const calculateDaysActive = () => {
    if (!user || !user.created_at) return 0;
    const registrationDate = new Date(user.created_at);
    const today = new Date();
    const differenceInTime = today.getTime() - registrationDate.getTime();
    const days = Math.ceil(differenceInTime / (1000 * 3600 * 24));
    return days > 0 ? days : 1;
  };

  // --- Handlers ---
  const handleTabChange = (newTab: string) => {
    setActiveTab(newTab);
    router.push(`/dashboard?tab=${newTab}`, { scroll: false });
  };

  const handleRemoveBookmark = async (calculatorId: string, event: React.MouseEvent) => {
    event.preventDefault();
    event.stopPropagation();
    if (!user) return;
    
    const prevBookmarks = [...bookmarkedCalculators];
    setBookmarkedCalculators((prev) => prev.filter((calc) => calc.id !== calculatorId));

    try {
      const result = await fetchAPI("/public/toggle_bookmark.php", {
        method: "POST",
        body: JSON.stringify({ userId: user.id, calculatorId: calculatorId }),
      });
      if (result.success) {
        toast.success("Bookmark removed");
      } else {
        setBookmarkedCalculators(prevBookmarks); 
        toast.error(result.message);
      }
    } catch (error) {
      setBookmarkedCalculators(prevBookmarks); 
      toast.error("Failed to connect to the server.");
    }
  };

  const formatDate = (dateString: string) => {
    try {
        const utcDate = new Date(dateString.replace(" ", "T") + "Z");
        return utcDate.toLocaleString(undefined, {
        day: "numeric", month: "short", year: "numeric", hour: "2-digit", minute: "2-digit", hour12: true
        });
    } catch (e) {
        return dateString;
    }
  };

  const handleDeleteCalculation = async (calculationId: number) => {
    if (!user || !window.confirm("Are you sure you want to delete this record?")) return;
    
    const prevCalculations = [...calculations];
    setCalculations((p) => p.filter((c) => c.id !== calculationId));

    try {
      const result = await fetchAPI("/public/delete_calculation.php", {
        method: "POST",
        body: JSON.stringify({ userId: user.id, calculationId: calculationId }),
      });
      if (result.success) {
        toast.success("Record deleted");
      } else {
        setCalculations(prevCalculations);
        toast.error(result.message);
      }
    } catch (e) {
      setCalculations(prevCalculations);
      toast.error("Connection failed.");
    }
  };

  const handleDeleteAllCalculations = async () => {
    if (!user || calculations.length === 0 || !window.confirm("Delete ALL history? This cannot be undone.")) return;
    
    const prevCalculations = [...calculations];
    setCalculations([]);

    try {
      const result = await fetchAPI("/public/delete_calculation.php", {
        method: "POST",
        body: JSON.stringify({ userId: user.id, deleteAll: true }),
      });
      if (result.success) {
        toast.success(result.message);
      } else {
        setCalculations(prevCalculations);
        toast.error(result.message);
      }
    } catch (e) {
      setCalculations(prevCalculations);
      toast.error("Connection failed.");
    }
  };

  const handleProfileSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    if (!user) return;
    setIsSubmittingProfile(true);
    try {
      const result = await fetchAPI("/public/update_profile.php", {
        method: "POST",
        body: JSON.stringify({ userId: user.id, name: formData.name, email: formData.email }),
      });
      if (result.success) {
        toast.success("Profile updated successfully");
        login({ ...user, name: result.user.name, email: result.user.email });
      } else {
        toast.error(result.message);
      }
    } catch (error) {
      toast.error("Update failed.");
    } finally {
      setIsSubmittingProfile(false);
    }
  };

  const handlePasswordSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    if (!user) return;
    if (!formData.currentPassword || !formData.newPassword || !formData.confirmPassword) {
      toast.error("All password fields are required.");
      return;
    }
    if (formData.newPassword !== formData.confirmPassword) {
      toast.error("New passwords do not match.");
      return;
    }
    const { isValid, errors } = validatePassword(formData.newPassword);
    if (!isValid) {
      toast.error(errors[0]);
      return;
    }
    setIsSubmittingPassword(true);
    try {
      const result = await fetchAPI("/public/update_password.php", {
        method: "POST",
        body: JSON.stringify({
          userId: user.id,
          currentPassword: formData.currentPassword,
          newPassword: formData.newPassword,
        }),
      });
      if (result.success) {
        toast.success("Password updated successfully");
        setFormData(prev => ({ ...prev, currentPassword: "", newPassword: "", confirmPassword: "" }));
      } else {
        toast.error(result.message);
      }
    } catch (error) {
      toast.error("Password update failed.");
    } finally {
      setIsSubmittingPassword(false);
    }
  };

  const RenderCalculationDetails = ({ calc }: { calc: any }) => {
    const formatCurrency = (amount: number) =>
      new Intl.NumberFormat("en-IN", { style: "currency", currency: "INR", maximumFractionDigits: 0 }).format(amount);

    if (!calc.inputs || !calc.results) return <p className="text-red-500 text-xs italic">Data corrupted or incomplete.</p>;

    switch (calc.calculator_type) {
      case "EMI Calculator":
        return (
          <div className="grid grid-cols-2 gap-y-3 gap-x-6">
            <div><p className="text-xs text-neutral-500 dark:text-neutral-400 uppercase tracking-wide font-semibold">Loan Amount</p><p className="font-medium text-neutral-900 dark:text-white">{formatCurrency(calc.inputs.loanAmount)}</p></div>
            <div><p className="text-xs text-neutral-500 dark:text-neutral-400 uppercase tracking-wide font-semibold">Interest</p><p className="font-medium text-neutral-900 dark:text-white">{calc.inputs.interestRate}%</p></div>
            <div><p className="text-xs text-neutral-500 dark:text-neutral-400 uppercase tracking-wide font-semibold">Tenure</p><p className="font-medium text-neutral-900 dark:text-white">{calc.inputs.loanTenure} years</p></div>
            <div className="p-2 bg-indigo-50 dark:bg-indigo-900/30 rounded-lg border border-indigo-100 dark:border-indigo-800/50"><p className="text-xs text-indigo-600 dark:text-indigo-400 uppercase tracking-wide font-bold">Monthly EMI</p><p className="font-bold text-indigo-700 dark:text-indigo-300">{formatCurrency(calc.results.emi)}</p></div>
          </div>
        );
      case "SIP Calculator":
        return (
          <div className="grid grid-cols-2 gap-y-3 gap-x-6">
            <div><p className="text-xs text-neutral-500 dark:text-neutral-400 uppercase tracking-wide font-semibold">Investment</p><p className="font-medium text-neutral-900 dark:text-white">{formatCurrency(calc.inputs.monthlyInvestment)}/mo</p></div>
            <div><p className="text-xs text-neutral-500 dark:text-neutral-400 uppercase tracking-wide font-semibold">Returns</p><p className="font-medium text-neutral-900 dark:text-white">{calc.inputs.expectedReturn}%</p></div>
            <div><p className="text-xs text-neutral-500 dark:text-neutral-400 uppercase tracking-wide font-semibold">Duration</p><p className="font-medium text-neutral-900 dark:text-white">{calc.inputs.timePeriod} years</p></div>
            <div className="p-2 bg-green-50 dark:bg-green-900/30 rounded-lg border border-green-100 dark:border-green-800/50"><p className="text-xs text-green-600 dark:text-green-400 uppercase tracking-wide font-bold">Maturity</p><p className="font-bold text-green-700 dark:text-green-300">{formatCurrency(calc.results.maturityValue)}</p></div>
          </div>
        );
      case "BMI Calculator":
        return (
            <div className="grid grid-cols-2 gap-y-3 gap-x-6">
            <div><p className="text-xs text-neutral-500 dark:text-neutral-400 uppercase tracking-wide font-semibold">Height</p><p className="font-medium text-neutral-900 dark:text-white">{calc.inputs.height} {calc.inputs.unit === 'metric' ? 'cm' : 'in'}</p></div>
            <div><p className="text-xs text-neutral-500 dark:text-neutral-400 uppercase tracking-wide font-semibold">Weight</p><p className="font-medium text-neutral-900 dark:text-white">{calc.inputs.weight} {calc.inputs.unit === 'metric' ? 'kg' : 'lbs'}</p></div>
            <div><p className="text-xs text-neutral-500 dark:text-neutral-400 uppercase tracking-wide font-semibold">BMI</p><p className="font-medium text-neutral-900 dark:text-white">{Number(calc.results.bmi).toFixed(1)}</p></div>
            <div className="p-2 bg-purple-50 dark:bg-purple-900/30 rounded-lg border border-purple-100 dark:border-purple-800/50"><p className="text-xs text-purple-600 dark:text-purple-400 uppercase tracking-wide font-bold">Category</p><p className="font-bold text-purple-700 dark:text-purple-300">{calc.results.category}</p></div>
          </div>
        );
      default:
        return (
            <div className="space-y-2">
                <p className="text-xs text-neutral-500 dark:text-neutral-400 italic">Snapshot of results:</p>
                <pre className="text-xs bg-neutral-100 dark:bg-neutral-800 p-2 rounded overflow-x-auto text-neutral-700 dark:text-neutral-300">
                    {JSON.stringify(calc.results, null, 2).substring(0, 100)}...
                </pre>
            </div>
        );
    }
  };

  // --- CRITICAL GUARD CLAUSE ---
  if (isLoading) {
    return (
      <div className="flex items-center justify-center min-h-screen bg-neutral-50 dark:bg-neutral-900">
        <div className="w-16 h-16 border-4 border-primary-500 border-t-transparent rounded-full animate-spin"></div>
      </div>
    );
  }

  if (!user) {
    return null; // Prevents UI flicker before redirect
  }

  // --- MAIN RENDER ---
  return (
    <div className="bg-neutral-50 dark:bg-neutral-900 min-h-screen py-8">
        <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
          
          {/* Header */}
          <div className="mb-10">
            <h1 className="text-3xl md:text-4xl font-extrabold text-neutral-900 dark:text-white tracking-tight">Dashboard</h1>
            <p className="text-neutral-600 dark:text-neutral-400 mt-2 font-medium">{welcomeMessage}</p>
          </div>

          <div className="grid grid-cols-1 lg:grid-cols-4 gap-8">
            
            {/* Sidebar */}
            <div className="lg:col-span-1">
              <div className="bg-white dark:bg-neutral-800 rounded-2xl shadow-sm border border-neutral-200 dark:border-neutral-700 overflow-hidden sticky top-24">
                <div className="p-8 border-b border-neutral-100 dark:border-neutral-700">
                  <div className="flex flex-col items-center space-y-3">
                    <div className="w-16 h-16 rounded-full bg-gradient-to-br from-indigo-500 to-violet-600 flex items-center justify-center text-white text-2xl font-bold shadow-inner">
                      {user.name.charAt(0).toUpperCase()}
                    </div>
                    <div className="text-center">
                      <h3 className="text-lg font-bold text-neutral-900 dark:text-white">{user.name}</h3>
                      <p className="text-xs text-neutral-500 dark:text-neutral-400 truncate max-w-[180px]">{user.email}</p>
                      <div className="flex items-center justify-center space-x-1.5 mt-2 bg-yellow-50 dark:bg-yellow-900/20 px-3 py-1 rounded-full border border-yellow-100 dark:border-yellow-800/50">
                        <SafeIcon icon={FiStar} className="w-3 h-3 text-yellow-600 dark:text-yellow-400" />
                        <span className="text-[10px] font-bold uppercase tracking-wide text-yellow-700 dark:text-yellow-400">Free Plan</span>
                      </div>
                    </div>
                  </div>
                </div>
                <nav className="p-4 space-y-1">
                    {[
                      { id: 'overview', label: 'Overview', icon: FiBarChart2 },
                      { id: 'calculations', label: 'Saved History', icon: FiClock },
                      { id: 'bookmarks', label: 'Bookmarks', icon: FiBookmark },
                      { id: 'settings', label: 'Settings', icon: FiSettings },
                    ].map(item => (
                        <button
                          key={item.id}
                          onClick={() => handleTabChange(item.id)}
                          className={`w-full flex items-center space-x-3 px-4 py-3 rounded-xl transition-all duration-200 text-sm font-medium group ${
                            activeTab === item.id
                              ? "bg-indigo-50 dark:bg-indigo-900/20 text-indigo-700 dark:text-indigo-400 shadow-sm ring-1 ring-indigo-200 dark:ring-indigo-800"
                              : "text-neutral-600 dark:text-neutral-400 hover:bg-neutral-50 dark:hover:bg-neutral-700/50 hover:text-neutral-900 dark:hover:text-white"
                          }`}
                        >
                          <SafeIcon icon={item.icon} className={`w-5 h-5 transition-colors ${activeTab === item.id ? "text-indigo-600 dark:text-indigo-400" : "text-neutral-400 group-hover:text-neutral-600"}`} />
                          <span>{item.label}</span>
                        </button>
                    ))}
                </nav>
                <div className="p-4 mt-2 border-t border-neutral-100 dark:border-neutral-700">
                    <button onClick={() => logout()} className="w-full flex items-center space-x-3 px-4 py-3 rounded-xl text-red-600 dark:text-red-400 hover:bg-red-50 dark:hover:bg-red-900/20 transition-all duration-200 text-sm font-medium group">
                      <SafeIcon icon={FiLogOut} className="w-5 h-5 group-hover:scale-110 transition-transform" />
                      <span>Sign Out</span>
                    </button>
                </div>
              </div>
            </div>

            {/* Main Content Area */}
            <div className="lg:col-span-3">
              
              {/* === OVERVIEW TAB === */}
              {activeTab === "overview" && (
                <motion.div initial={{ opacity: 0, y: 10 }} animate={{ opacity: 1, y: 0 }} transition={{ duration: 0.4 }} className="space-y-8">
                  
                  {/* Stats Grid */}
                  <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div className="bg-white dark:bg-neutral-800 rounded-2xl shadow-sm border border-neutral-200 dark:border-neutral-700 p-6 flex items-center justify-between group hover:border-indigo-200 dark:hover:border-indigo-800 transition-colors">
                        <div>
                          <p className="text-xs text-neutral-500 dark:text-neutral-400 uppercase tracking-wider font-semibold mb-1">Saved Items</p>
                          <p className="text-3xl font-bold text-neutral-900 dark:text-white">{calculations.length}</p>
                        </div>
                        <div className="w-12 h-12 bg-blue-50 dark:bg-blue-900/20 rounded-xl flex items-center justify-center text-blue-600 dark:text-blue-400 group-hover:scale-110 transition-transform">
                          <SafeIcon icon={FiCalculator} className="w-6 h-6" />
                        </div>
                    </div>
                    <div className="bg-white dark:bg-neutral-800 rounded-2xl shadow-sm border border-neutral-200 dark:border-neutral-700 p-6 flex items-center justify-between group hover:border-green-200 dark:hover:border-green-800 transition-colors">
                        <div>
                          <p className="text-xs text-neutral-500 dark:text-neutral-400 uppercase tracking-wider font-semibold mb-1">Bookmarks</p>
                          <p className="text-3xl font-bold text-neutral-900 dark:text-white">{bookmarkedCalculators.length}</p>
                        </div>
                        <div className="w-12 h-12 bg-green-50 dark:bg-green-900/20 rounded-xl flex items-center justify-center text-green-600 dark:text-green-400 group-hover:scale-110 transition-transform">
                          <SafeIcon icon={FiBookmark} className="w-6 h-6" />
                        </div>
                    </div>
                    <div className="bg-white dark:bg-neutral-800 rounded-2xl shadow-sm border border-neutral-200 dark:border-neutral-700 p-6 flex items-center justify-between group hover:border-purple-200 dark:hover:border-purple-800 transition-colors">
                        <div>
                          <p className="text-xs text-neutral-500 dark:text-neutral-400 uppercase tracking-wider font-semibold mb-1">Member Since</p>
                          <p className="text-3xl font-bold text-neutral-900 dark:text-white">{calculateDaysActive()}<span className="text-sm font-normal text-neutral-400 ml-1">days</span></p>
                        </div>
                        <div className="w-12 h-12 bg-purple-50 dark:bg-purple-900/20 rounded-xl flex items-center justify-center text-purple-600 dark:text-purple-400 group-hover:scale-110 transition-transform">
                          <SafeIcon icon={FiCalendar} className="w-6 h-6" />
                        </div>
                    </div>
                  </div>

                  {/* Bookmarks Preview */}
                  <div className="bg-white dark:bg-neutral-800 rounded-2xl shadow-sm border border-neutral-200 dark:border-neutral-700 overflow-hidden">
                    <div className="p-6 border-b border-neutral-100 dark:border-neutral-700/50 flex justify-between items-center">
                      <h3 className="text-lg font-bold text-neutral-900 dark:text-white">Quick Access</h3>
                      <button onClick={() => handleTabChange('bookmarks')} className="text-xs font-semibold text-indigo-600 dark:text-indigo-400 hover:underline">View All</button>
                    </div>
                    <div className="p-6">
                      {isLoadingBookmarks ? (
                         <div className="flex justify-center py-8"><div className="w-6 h-6 border-2 border-indigo-500 border-t-transparent rounded-full animate-spin"></div></div>
                      ) : bookmarkedCalculators.length > 0 ? (
                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                          {bookmarkedCalculators.slice(0, 3).map((calc) => (
                            <Link key={calc.id} href={`/calculators/${calc.slug || calc.id}`} className="flex items-center space-x-3 p-4 bg-neutral-50 dark:bg-neutral-700/30 rounded-xl border border-neutral-100 dark:border-neutral-700 hover:border-indigo-300 dark:hover:border-indigo-700 hover:shadow-md transition-all group">
                              <div className={`w-10 h-10 bg-gradient-to-br ${calc.color} rounded-lg flex items-center justify-center flex-shrink-0 shadow-sm`}>
                                <SafeIcon icon={calc.icon} className="w-5 h-5 text-white" />
                              </div>
                              <div className="min-w-0">
                                <p className="font-semibold text-neutral-900 dark:text-white text-sm truncate group-hover:text-indigo-600 dark:group-hover:text-indigo-400 transition-colors">{calc.name}</p>
                                <p className="text-xs text-neutral-500 dark:text-neutral-400 truncate">Bookmarked</p>
                              </div>
                            </Link>
                          ))}
                        </div>
                      ) : (
                        <div className="text-center py-10">
                          <div className="w-12 h-12 bg-neutral-100 dark:bg-neutral-800 rounded-full flex items-center justify-center mx-auto mb-3">
                             <SafeIcon icon={FiBookmark} className="w-6 h-6 text-neutral-400" />
                          </div>
                          <p className="text-neutral-500 dark:text-neutral-400 text-sm">Your bookmarks will appear here.</p>
                        </div>
                      )}
                    </div>
                  </div>
                </motion.div>
              )}

              {/* === CALCULATIONS TAB === */}
              {activeTab === "calculations" && (
                <motion.div initial={{ opacity: 0, y: 10 }} animate={{ opacity: 1, y: 0 }} transition={{ duration: 0.4 }} className="bg-white dark:bg-neutral-800 rounded-2xl shadow-sm border border-neutral-200 dark:border-neutral-700 overflow-hidden">
                  <div className="p-6 border-b border-neutral-100 dark:border-neutral-700/50 flex items-center justify-between bg-neutral-50/50 dark:bg-neutral-800/50">
                    <div>
                        <h2 className="text-lg font-bold text-neutral-900 dark:text-white">History</h2>
                        <p className="text-xs text-neutral-500 mt-1">Recent calculations saved to your account.</p>
                    </div>
                    {calculations.length > 0 && (
                      <button onClick={handleDeleteAllCalculations} className="flex items-center space-x-2 px-3 py-1.5 rounded-lg text-xs font-bold text-red-600 dark:text-red-400 bg-red-50 dark:bg-red-900/20 hover:bg-red-100 dark:hover:bg-red-900/40 transition-colors">
                        <SafeIcon icon={FiTrash} className="w-3.5 h-3.5" /> <span>Clear All</span>
                      </button>
                    )}
                  </div>
                  <div className="divide-y divide-neutral-100 dark:divide-neutral-700/50">
                    {isLoadingHistory ? (
                      <div className="p-12 text-center text-neutral-500">Loading history...</div>
                    ) : calculations.length > 0 ? (
                      calculations.map((calc) => (
                        <div key={calc.id} className="p-6 hover:bg-neutral-50 dark:hover:bg-neutral-700/30 transition-colors group">
                          <div className="flex flex-col sm:flex-row sm:items-start sm:justify-between mb-4">
                            <div className="flex items-center space-x-4 mb-2 sm:mb-0">
                              <div className="w-10 h-10 bg-indigo-100 dark:bg-indigo-900/30 text-indigo-600 dark:text-indigo-400 rounded-xl flex items-center justify-center">
                                <SafeIcon icon={FiCalculator} className="w-5 h-5" />
                              </div>
                              <div>
                                <h3 className="text-sm font-bold text-neutral-900 dark:text-white">{calc.calculator_type}</h3>
                                <div className="flex items-center text-xs text-neutral-500 dark:text-neutral-400 mt-0.5">
                                    <SafeIcon icon={FiClock} className="w-3 h-3 mr-1" />
                                    {formatDate(calc.created_at)}
                                </div>
                              </div>
                            </div>
                            <button onClick={() => handleDeleteCalculation(calc.id)} className="p-2 rounded-lg text-neutral-400 hover:text-red-500 hover:bg-red-50 dark:hover:bg-red-900/20 transition-all opacity-0 group-hover:opacity-100 self-end sm:self-start">
                              <SafeIcon icon={FiTrash2} className="w-4 h-4" />
                            </button>
                          </div>
                          
                          <div className="bg-neutral-50 dark:bg-neutral-900/50 rounded-xl p-4 border border-neutral-100 dark:border-neutral-700/50 text-sm">
                            <RenderCalculationDetails calc={calc} />
                          </div>
                        </div>
                      ))
                    ) : (
                      <div className="p-12 text-center">
                          <div className="w-16 h-16 bg-neutral-100 dark:bg-neutral-800 rounded-full flex items-center justify-center mx-auto mb-4">
                             <SafeIcon icon={FiClock} className="w-8 h-8 text-neutral-400" />
                          </div>
                          <h3 className="text-neutral-900 dark:text-white font-medium">No history found</h3>
                          <p className="text-sm text-neutral-500 mt-1">Calculations you save will appear here.</p>
                      </div>
                    )}
                  </div>
                </motion.div>
              )}

              {/* === BOOKMARKS TAB === */}
              {activeTab === "bookmarks" && (
                <motion.div initial={{ opacity: 0, y: 10 }} animate={{ opacity: 1, y: 0 }} transition={{ duration: 0.4 }} className="bg-white dark:bg-neutral-800 rounded-2xl shadow-sm border border-neutral-200 dark:border-neutral-700 overflow-hidden">
                   <div className="p-6 border-b border-neutral-200 dark:border-neutral-700 bg-neutral-50/50 dark:bg-neutral-800/50">
                    <h2 className="text-lg font-bold text-neutral-900 dark:text-white">Your Bookmarks</h2>
                    <p className="text-xs text-neutral-500 mt-1">Quick access to your favorite tools.</p>
                  </div>
                  <div className="p-6">
                    {isLoadingBookmarks ? (
                      <div className="p-12 text-center text-neutral-500">Loading bookmarks...</div>
                    ) : bookmarkedCalculators.length > 0 ? (
                      <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                        {bookmarkedCalculators.map((calc) => (
                          <Link key={calc.id} href={`/calculators/${calc.slug || calc.id}`} className="group relative flex items-start space-x-4 p-5 rounded-xl bg-white dark:bg-neutral-700/20 border border-neutral-200 dark:border-neutral-700 hover:border-indigo-300 dark:hover:border-indigo-700 hover:shadow-md transition-all">
                            <div className={`w-12 h-12 bg-gradient-to-br ${calc.color} rounded-xl flex items-center justify-center text-white flex-shrink-0 shadow-sm group-hover:scale-110 transition-transform duration-300`}>
                              <SafeIcon icon={calc.icon} className="w-6 h-6" />
                            </div>
                            <div className="flex-grow min-w-0">
                              <h3 className="font-bold text-neutral-900 dark:text-white group-hover:text-indigo-600 dark:group-hover:text-indigo-400 transition-colors">{calc.name}</h3>
                              <p className="text-xs text-neutral-500 dark:text-neutral-400 mt-1 line-clamp-2">{calc.description}</p>
                            </div>
                            <button onClick={(e) => handleRemoveBookmark(calc.id, e)} className="absolute top-3 right-3 p-1.5 rounded-full text-neutral-400 hover:text-red-500 hover:bg-red-50 dark:hover:bg-red-900/20 opacity-0 group-hover:opacity-100 transition-all transform hover:scale-110" title="Remove Bookmark">
                              <SafeIcon icon={FiXCircle} className="w-5 h-5" />
                            </button>
                          </Link>
                        ))}
                      </div>
                    ) : (
                      <div className="p-12 text-center">
                          <div className="w-16 h-16 bg-neutral-100 dark:bg-neutral-800 rounded-full flex items-center justify-center mx-auto mb-4">
                             <SafeIcon icon={FiBookmark} className="w-8 h-8 text-neutral-400" />
                          </div>
                          <h3 className="text-neutral-900 dark:text-white font-medium">No bookmarks yet</h3>
                          <p className="text-sm text-neutral-500 mt-1">Click the bookmark icon on any calculator to save it here.</p>
                      </div>
                    )}
                  </div>
                </motion.div>
              )}

              {/* === SETTINGS TAB === */}
              {activeTab === "settings" && (
                <div className="space-y-8">
                  {/* Profile Settings */}
                  <motion.div initial={{ opacity: 0, y: 10 }} animate={{ opacity: 1, y: 0 }} transition={{ duration: 0.4 }} className="bg-white dark:bg-neutral-800 rounded-2xl shadow-sm border border-neutral-200 dark:border-neutral-700 overflow-hidden">
                    <div className="p-6 border-b border-neutral-200 dark:border-neutral-700 bg-neutral-50/50 dark:bg-neutral-800/50">
                      <h3 className="text-lg font-bold text-neutral-900 dark:text-white flex items-center gap-2">
                          <SafeIcon icon={FiUser} className="w-5 h-5 text-indigo-500" /> Profile Information
                      </h3>
                    </div>
                    <div className="p-8">
                      <form onSubmit={handleProfileSubmit} className="space-y-6">
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                          <div className="space-y-2">
                            <label className="text-xs font-bold text-neutral-500 dark:text-neutral-400 uppercase tracking-wider">Full Name</label>
                            <div className="relative group">
                              <SafeIcon icon={FiUser} className="absolute left-3 top-1/2 transform -translate-y-1/2 text-neutral-400 group-focus-within:text-indigo-500 transition-colors w-5 h-5" />
                              <input type="text" value={formData.name} onChange={(e) => setFormData(p => ({...p, name: e.target.value}))} className="w-full pl-10 pr-4 py-3 border border-neutral-200 dark:border-neutral-700 rounded-xl focus:ring-2 focus:ring-indigo-500 focus:border-transparent bg-white dark:bg-neutral-900 text-neutral-900 dark:text-white transition-all outline-none" />
                            </div>
                          </div>
                          <div className="space-y-2">
                            <label className="text-xs font-bold text-neutral-500 dark:text-neutral-400 uppercase tracking-wider">Email Address</label>
                            <div className="relative group">
                              <SafeIcon icon={FiMail} className="absolute left-3 top-1/2 transform -translate-y-1/2 text-neutral-400 group-focus-within:text-indigo-500 transition-colors w-5 h-5" />
                              <input type="email" value={formData.email} onChange={(e) => setFormData(p => ({...p, email: e.target.value}))} className="w-full pl-10 pr-4 py-3 border border-neutral-200 dark:border-neutral-700 rounded-xl focus:ring-2 focus:ring-indigo-500 focus:border-transparent bg-white dark:bg-neutral-900 text-neutral-900 dark:text-white transition-all outline-none" />
                            </div>
                          </div>
                        </div>
                        <div className="pt-6 border-t border-neutral-100 dark:border-neutral-700 flex justify-end">
                          <button type="submit" disabled={isSubmittingProfile} className="flex items-center space-x-2 bg-indigo-600 hover:bg-indigo-700 text-white px-6 py-3 rounded-xl transition-all font-bold shadow-lg shadow-indigo-500/30 hover:shadow-indigo-500/50 disabled:opacity-70 transform hover:-translate-y-0.5">
                            <SafeIcon icon={FiEdit3} className="w-4 h-4" />
                            <span>{isSubmittingProfile ? "Saving..." : "Save Changes"}</span>
                          </button>
                        </div>
                      </form>
                    </div>
                  </motion.div>
                  
                  {/* Security Settings */}
                  <motion.div initial={{ opacity: 0, y: 10 }} animate={{ opacity: 1, y: 0 }} transition={{ duration: 0.4, delay: 0.1 }} className="bg-white dark:bg-neutral-800 rounded-2xl shadow-sm border border-neutral-200 dark:border-neutral-700 overflow-hidden">
                     <div className="p-6 border-b border-neutral-200 dark:border-neutral-700 bg-neutral-50/50 dark:bg-neutral-800/50">
                      <h3 className="text-lg font-bold text-neutral-900 dark:text-white flex items-center gap-2">
                          <SafeIcon icon={FiLock} className="w-5 h-5 text-indigo-500" /> Security
                      </h3>
                    </div>
                    <div className="p-8">
                      <form onSubmit={handlePasswordSubmit} className="space-y-6">
                        <div className="space-y-2">
                          <label className="text-xs font-bold text-neutral-500 dark:text-neutral-400 uppercase tracking-wider">Current Password</label>
                          <div className="relative group">
                            <SafeIcon icon={FiLock} className="absolute left-3 top-1/2 transform -translate-y-1/2 text-neutral-400 group-focus-within:text-indigo-500 transition-colors w-5 h-5" />
                            <input type="password" value={formData.currentPassword} onChange={(e) => setFormData(p => ({...p, currentPassword: e.target.value}))} className="w-full pl-10 pr-4 py-3 border border-neutral-200 dark:border-neutral-700 rounded-xl focus:ring-2 focus:ring-indigo-500 focus:border-transparent bg-white dark:bg-neutral-900 text-neutral-900 dark:text-white transition-all outline-none" placeholder="••••••••" />
                          </div>
                        </div>
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                          <div className="space-y-2">
                            <label className="text-xs font-bold text-neutral-500 dark:text-neutral-400 uppercase tracking-wider">New Password</label>
                            <div className="relative group">
                              <SafeIcon icon={FiCheckCircle} className="absolute left-3 top-1/2 transform -translate-y-1/2 text-neutral-400 group-focus-within:text-green-500 transition-colors w-5 h-5" />
                              <input type="password" value={formData.newPassword} onChange={(e) => setFormData(p => ({...p, newPassword: e.target.value}))} className="w-full pl-10 pr-4 py-3 border border-neutral-200 dark:border-neutral-700 rounded-xl focus:ring-2 focus:ring-indigo-500 focus:border-transparent bg-white dark:bg-neutral-900 text-neutral-900 dark:text-white transition-all outline-none" placeholder="New strong password" />
                            </div>
                          </div>
                          <div className="space-y-2">
                            <label className="text-xs font-bold text-neutral-500 dark:text-neutral-400 uppercase tracking-wider">Confirm Password</label>
                            <div className="relative group">
                              <SafeIcon icon={FiCheckCircle} className="absolute left-3 top-1/2 transform -translate-y-1/2 text-neutral-400 group-focus-within:text-green-500 transition-colors w-5 h-5" />
                              <input type="password" value={formData.confirmPassword} onChange={(e) => setFormData(p => ({...p, confirmPassword: e.target.value}))} className="w-full pl-10 pr-4 py-3 border border-neutral-200 dark:border-neutral-700 rounded-xl focus:ring-2 focus:ring-indigo-500 focus:border-transparent bg-white dark:bg-neutral-900 text-neutral-900 dark:text-white transition-all outline-none" placeholder="Repeat password" />
                            </div>
                          </div>
                        </div>
                        
                        <div className="flex items-start gap-2 p-4 bg-blue-50 dark:bg-blue-900/20 border border-blue-100 dark:border-blue-800 rounded-xl">
                            <SafeIcon icon={FiAlertCircle} className="w-5 h-5 text-blue-600 dark:text-blue-400 shrink-0 mt-0.5" />
                            <p className="text-xs text-blue-700 dark:text-blue-300 leading-relaxed">
                                Password must be at least 8 characters long and include a mix of letters, numbers, and symbols for security.
                            </p>
                        </div>

                        <div className="pt-6 border-t border-neutral-100 dark:border-neutral-700 flex justify-end">
                          <button type="submit" disabled={isSubmittingPassword} className="flex items-center space-x-2 bg-indigo-600 hover:bg-indigo-700 text-white px-6 py-3 rounded-xl transition-all font-bold shadow-lg shadow-indigo-500/30 hover:shadow-indigo-500/50 disabled:opacity-70 transform hover:-translate-y-0.5">
                            <SafeIcon icon={FiLock} className="w-4 h-4" />
                            <span>{isSubmittingPassword ? "Updating..." : "Update Password"}</span>
                          </button>
                        </div>
                      </form>
                    </div>
                  </motion.div>
                </div>
              )}

            </div>
          </div>
        </div>
    </div>
  );
};

export default ClientDashboard;