<?php
// Core utilities
require_once '../../core/config.php';
require_once '../../core/response.php';
require_once '../../core/auth.php';

// --- SECURITY CHECK ---
// Verifies the JWT and gets the logged-in admin's ID.
$admin_data = verifyAdminToken();
$admin_id = $admin_data->adminId;

try {
    // --- 1. Get Incoming Data ---
    $json = file_get_contents('php://input');
    $data = json_decode($json);

    // --- 2. Validation ---
    if (!isset($data->currentPassword) || empty($data->currentPassword)) {
        sendResponse(false, null, 'Current password is required.', 400, 'INVALID_INPUT');
    }
    if (!isset($data->newPassword) || empty($data->newPassword)) {
        sendResponse(false, null, 'New password is required.', 400, 'INVALID_INPUT');
    }
    if (strlen($data->newPassword) < 8) {
        sendResponse(false, null, 'New password must be at least 8 characters long.', 400, 'WEAK_PASSWORD');
    }

    // --- 3. Sanitize Data ---
    $currentPassword = $data->currentPassword;
    $newPassword = $data->newPassword;

    // --- 4. Verify Current Password ---
    // First, we fetch the current hashed password from the database for the logged-in admin.
    $sql_fetch = "SELECT password FROM admins WHERE id = ?";
    $stmt_fetch = $conn->prepare($sql_fetch);
    $stmt_fetch->bind_param("i", $admin_id);
    $stmt_fetch->execute();
    $result = $stmt_fetch->get_result();
    
    if ($result->num_rows === 0) {
        $stmt_fetch->close();
        sendResponse(false, null, 'Admin account not found.', 404, 'NOT_FOUND');
    }
    
    $admin = $result->fetch_assoc();
    $currentHashedPassword = $admin['password'];
    $stmt_fetch->close();

    // Now, we use password_verify() to securely check if the provided current password is correct.
    if (!password_verify($currentPassword, $currentHashedPassword)) {
        sendResponse(false, null, 'The current password you entered is incorrect.', 401, 'AUTH_FAILED');
    }

    // --- 5. Hash and Update the New Password ---
    // If the current password was correct, we hash the new password and update the database.
    $newHashedPassword = password_hash($newPassword, PASSWORD_BCRYPT);
    
    $sql_update = "UPDATE admins SET password = ? WHERE id = ?";
    $stmt_update = $conn->prepare($sql_update);
    $stmt_update->bind_param("si", $newHashedPassword, $admin_id);

    if ($stmt_update->execute()) {
        sendResponse(true, null, 'Password updated successfully!');
    } else {
        throw new Exception("Database password update failed: " . $stmt_update->error);
    }
    $stmt_update->close();

} catch (Exception $e) {
    error_log("Error in update_admin_password.php: " . $e->getMessage());
    sendResponse(false, null, 'An internal server error occurred.', 500, 'SERVER_ERROR');
}

$conn->close();
?>