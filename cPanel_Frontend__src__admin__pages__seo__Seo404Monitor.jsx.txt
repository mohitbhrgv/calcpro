import React, { useState, useEffect, useCallback, useMemo } from "react";
import { useNavigate } from "react-router-dom";
import { motion, AnimatePresence } from "framer-motion";
import DataTable from "../../components/common/DataTable";
import SafeIcon from "../../../common/SafeIcon";
import Modal from "../../components/common/Modal";
import * as FiIcons from "react-icons/fi";
import toast from "react-hot-toast";
import { authenticatedFetch } from "../../utils/apiService";
import LoadingSpinner from "../../components/common/LoadingSpinner";
import { useAdminCache } from "../../context/AdminCacheContext";
import Monitor404SettingsModal from "../../components/seo/Monitor404SettingsModal";
import Monitor404HelpModal from "../../components/help/404MonitorHelpModal";

const { 
  FiActivity, 
  FiTrash2, 
  FiCornerUpRight, 
  FiSearch, 
  FiSettings,
  FiInfo 
} = FiIcons;

const Seo404Monitor = () => {
  const navigate = useNavigate();
  const { getCache, invalidateCache } = useAdminCache();

  const [logs, setLogs] = useState([]);
  const [pagination, setPagination] = useState({ currentPage: 1, totalPages: 1, totalRecords: 0 });
  const [loading, setLoading] = useState(true);
  const [isUpdating, setIsUpdating] = useState(false);
  const [isSubmitting, setIsSubmitting] = useState(false); // Guard for async actions
  const [searchTerm, setSearchTerm] = useState("");
  const [debouncedSearch, setDebouncedSearch] = useState("");
  
  const [selectedIds, setSelectedIds] = useState([]);
  const [confirmModal, setConfirmModal] = useState({ isOpen: false, type: null, data: null });
  const [isSettingsOpen, setIsSettingsOpen] = useState(false);
  const [isHelpOpen, setIsHelpOpen] = useState(false);

  // Constants for Deduplication
  const ACTION_TOAST_ID = "404-monitor-action";

  const settings = getCache("settings_general");
  const isAdvancedMode = settings?.seo_404_monitor_mode === "advanced";

  const fetchLogs = useCallback(async (page = 1, search = "") => {
    setIsUpdating(true);
    try {
      const result = await authenticatedFetch(
        `http://localhost/calcpro-api/api/admin/get_404_logs.php?page=${page}&search=${search}`
      );
      if (result.success) {
        setLogs(result.data.logs);
        setPagination(result.data.pagination);
      }
    } catch (error) {
      toast.error("Failed to load 404 logs.");
    } finally {
      setLoading(false);
      setIsUpdating(false);
    }
  }, []);

  useEffect(() => {
    fetchLogs(pagination.currentPage, debouncedSearch);
  }, [pagination.currentPage, debouncedSearch, fetchLogs]);

  useEffect(() => {
    const handler = setTimeout(() => setDebouncedSearch(searchTerm), 500);
    return () => clearTimeout(handler);
  }, [searchTerm]);

  // --- REFACTORED ACTION HANDLERS ---

  const executeDelete = async (ids) => {
    if (isSubmitting) return;
    setIsSubmitting(true);

    const isBulk = Array.isArray(ids);
    const endpoint = isBulk ? "delete_404_logs_bulk.php" : "delete_404_log.php";
    const body = isBulk ? { ids } : { id: ids };

    toast.loading(isBulk ? "Deleting selected entries..." : "Deleting log entry...", { id: ACTION_TOAST_ID });

    try {
      const result = await authenticatedFetch(
        `http://localhost/calcpro-api/api/admin/${endpoint}`,
        { method: "POST", body: JSON.stringify(body) }
      );
      if (result.success) {
        toast.success(result.message, { id: ACTION_TOAST_ID });
        if (isBulk) setSelectedIds([]);
        setConfirmModal({ isOpen: false, type: null, data: null });
        fetchLogs(pagination.currentPage, debouncedSearch);
      } else {
        toast.error(result.message || "Deletion failed.", { id: ACTION_TOAST_ID });
      }
    } catch (error) {
      toast.error("An error occurred during deletion.", { id: ACTION_TOAST_ID });
    } finally {
      setIsSubmitting(false);
    }
  };

  const handleClearLog = async () => {
    if (isSubmitting) return;
    setIsSubmitting(true);

    toast.loading("Clearing all logs...", { id: ACTION_TOAST_ID });
    try {
      const result = await authenticatedFetch(
        "http://localhost/calcpro-api/api/admin/clear_404_logs.php",
        { method: "POST" }
      );
      if (result.success) {
        toast.success(result.message, { id: ACTION_TOAST_ID });
        setSelectedIds([]);
        setConfirmModal({ isOpen: false, type: null, data: null });
        fetchLogs(1, "");
      } else {
        toast.error(result.message || "Failed to clear logs.", { id: ACTION_TOAST_ID });
      }
    } catch (error) {
      toast.error("An error occurred.", { id: ACTION_TOAST_ID });
    } finally {
      setIsSubmitting(false);
    }
  };

  const executeRedirect = (uri) => {
    setConfirmModal({ isOpen: false, type: null, data: null });
    navigate("/admin/seo/redirects", { state: { sourcePath: uri } });
  };

  const handleSelectRow = (id) => {
    setSelectedIds((prev) =>
      prev.includes(id) ? prev.filter((i) => i !== id) : [...prev, id]
    );
  };

  const handleSelectAll = (e) => {
    if (e.target.checked) {
      setSelectedIds(logs.map((log) => log.id));
    } else {
      setSelectedIds([]);
    }
  };

  const columns = useMemo(() => {
    const cols = [
      {
        key: "uri",
        label: "URI (Path)",
        wrap: true,
        render: (val) => (
          <span className="font-mono text-sm text-indigo-600 dark:text-indigo-400 break-all">
            {val}
          </span>
        ),
      },
      {
        key: "hits",
        label: "Hits",
        render: (val) => (
          <span className="font-bold text-gray-900 dark:text-white bg-gray-100 dark:bg-gray-700 px-2 py-0.5 rounded">
            {val}
          </span>
        ),
      },
      {
        key: "ip_address",
        label: "Last IP",
        render: (val) => <span className="text-xs text-gray-500 font-mono">{val}</span>,
      }
    ];

    if (isAdvancedMode) {
      cols.push({
        key: "referer",
        label: "Referer",
        wrap: true,
        render: (val) => (
          <span className="text-xs text-gray-500 break-all">
            {val || "Direct / Internal"}
          </span>
        ),
      });
    }

    cols.push({
      key: "updated_at",
      label: "Last Access",
      render: (val) => (
        <span className="text-xs text-gray-500">
          {new Date(val).toLocaleString()}
        </span>
      ),
    });

    return cols;
  }, [isAdvancedMode]);

  if (loading) return <LoadingSpinner size="xl" className="h-64" />;

  return (
    <div className="space-y-6">
      
      <Monitor404HelpModal 
        isOpen={isHelpOpen} 
        onClose={() => setIsHelpOpen(false)} 
        disableAnimation={true}
      />

      <Monitor404SettingsModal 
        isOpen={isSettingsOpen} 
        onClose={() => setIsSettingsOpen(false)} 
        disableAnimation={true}
      />

      <Modal
        isOpen={confirmModal.isOpen}
        onClose={() => !isSubmitting && setConfirmModal({ isOpen: false, type: null, data: null })}
        title={
            confirmModal.type === "clear" ? "Clear All Logs?" : 
            confirmModal.type === "bulk_delete" ? `Delete ${selectedIds.length} Logs?` :
            confirmModal.type === "redirect" ? "Are you sure!" : 
            "Delete Log Entry?"
        }
        type={confirmModal.type === "redirect" ? "info" : "danger"}
        disableAnimation={true}
      >
        <div className="space-y-4">
          <div className="p-3 bg-gray-50 dark:bg-gray-700/50 rounded-lg text-sm text-gray-600 dark:text-gray-300">
            {confirmModal.type === "clear" && "This will permanently remove all recorded 404 errors. This action cannot be undone."}
            {confirmModal.type === "bulk_delete" && `You are about to delete ${selectedIds.length} selected entries. This action cannot be undone.`}
            {confirmModal.type === "delete" && "Are you sure you want to remove this log entry?"}
            {confirmModal.type === "redirect" && (
                <>
                    You are being moved to the Redirection Manager to fix:
                    <div className="mt-2 font-mono text-xs p-2 bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-600 rounded text-indigo-600 dark:text-indigo-400 truncate">
                        {confirmModal.data}
                    </div>
                </>
            )}
          </div>
          <div className="flex justify-end gap-3 pt-2">
            <button
              type="button"
              disabled={isSubmitting}
              onClick={() => setConfirmModal({ isOpen: false, type: null, data: null })}
              className="px-4 py-2 text-sm font-medium text-gray-600 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg transition-colors disabled:opacity-50"
            >
              Cancel
            </button>
            <button
              type="button"
              disabled={isSubmitting}
              onClick={() => {
                if (confirmModal.type === "clear") handleClearLog();
                else if (confirmModal.type === "bulk_delete") executeDelete(selectedIds);
                else if (confirmModal.type === "delete") executeDelete(confirmModal.data);
                else if (confirmModal.type === "redirect") executeRedirect(confirmModal.data);
              }}
              className={`px-4 py-2 text-sm font-bold text-white rounded-lg transition-colors shadow-sm disabled:opacity-50 ${
                confirmModal.type === "redirect" ? "bg-indigo-600 hover:bg-indigo-700" : "bg-red-600 hover:bg-red-700"
              }`}
            >
              {isSubmitting ? "Processing..." : (confirmModal.type === "redirect" ? "Yes, Proceed" : "Confirm Action")}
            </button>
          </div>
        </div>
      </Modal>

      <div className="flex items-start gap-4 p-4 rounded-lg bg-indigo-50 dark:bg-indigo-900/20 border border-indigo-100 dark:border-indigo-800/50">
        <div className="p-2 bg-indigo-100 dark:bg-indigo-800 rounded-lg text-indigo-600 dark:text-indigo-300 shrink-0">
          <SafeIcon icon={FiActivity} className="w-5 h-5" />
        </div>
        <div className="flex-1 flex flex-col md:flex-row justify-between gap-4">
          <div>
            <div className="flex items-center gap-2">
                <h4 className="font-bold text-gray-900 dark:text-white">404 Monitor</h4>
                <button
                    onClick={() => setIsHelpOpen(true)}
                    className="text-gray-400 hover:text-indigo-600 dark:hover:text-indigo-400 transition-colors p-1 rounded-full hover:bg-indigo-50 dark:hover:bg-indigo-900/30"
                    title="Monitor Guide"
                >
                    <SafeIcon icon={FiInfo} className="w-4 h-4" />
                </button>
            </div>
            <p className="text-sm text-gray-600 dark:text-gray-300 mt-1 leading-relaxed">
              Track broken links and missing pages. Convert them into redirects to preserve your SEO ranking.
            </p>
          </div>
          <div className="shrink-0 flex gap-2">
             <button
                onClick={() => setIsSettingsOpen(true)}
                className="flex items-center gap-2 px-4 py-2 bg-white dark:bg-gray-800 text-gray-600 dark:text-gray-300 border border-gray-200 dark:border-gray-700 rounded-lg text-sm font-medium hover:bg-gray-50 dark:hover:bg-gray-700/50 transition-all shadow-sm"
             >
                <SafeIcon icon={FiSettings} className="w-4 h-4" /> Settings
             </button>

             <button
                onClick={() => setConfirmModal({ isOpen: true, type: "clear" })}
                className="flex items-center gap-2 px-4 py-2 bg-white dark:bg-gray-800 text-red-600 border border-red-200 dark:border-red-900 rounded-lg text-sm font-bold hover:bg-red-50 dark:hover:bg-red-900/20 transition-all shadow-sm"
             >
                <SafeIcon icon={FiTrash2} className="w-4 h-4" /> Clear Log
             </button>
          </div>
        </div>
      </div>

      <div className="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 overflow-hidden relative min-h-[400px]">
        <AnimatePresence>
            {(isUpdating || isSubmitting) && (
                <motion.div initial={{ opacity: 0 }} animate={{ opacity: 1 }} exit={{ opacity: 0 }} className="absolute inset-0 bg-white/60 dark:bg-gray-900/60 backdrop-blur-[1px] z-10 flex items-center justify-center">
                    <LoadingSpinner size="lg" />
                </motion.div>
            )}
        </AnimatePresence>

        <div className="px-6 py-3 border-b border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-gray-700/50 flex flex-col sm:flex-row justify-between items-center gap-4">
            <div className="flex items-center gap-4 w-full sm:w-auto">
                <AnimatePresence>
                {selectedIds.length > 0 && (
                    <motion.div 
                        initial={{ opacity: 0, x: -10 }} animate={{ opacity: 1, x: 0 }} exit={{ opacity: 0, x: -10 }}
                        className="flex items-center gap-2 pr-4 border-r border-gray-300 dark:border-gray-600"
                    >
                        <span className="text-xs font-bold text-indigo-700 dark:text-indigo-400">{selectedIds.length} Selected</span>
                        <button 
                            onClick={() => setConfirmModal({ isOpen: true, type: "bulk_delete" })}
                            className="flex items-center gap-1 px-2 py-1.5 bg-red-50 dark:bg-red-900/30 text-red-600 dark:text-red-400 hover:bg-red-100 dark:hover:bg-red-900/50 rounded text-xs font-bold transition-colors border border-red-200 dark:border-red-800"
                        >
                            <SafeIcon icon={FiTrash2} className="w-3.5 h-3.5" /> Delete
                        </button>
                    </motion.div>
                )}
                </AnimatePresence>
                
                <div className="relative w-full sm:w-64">
                    <SafeIcon icon={FiSearch} className="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400 w-4 h-4" />
                    <input 
                        type="text" 
                        placeholder="Search URLs..." 
                        value={searchTerm}
                        onChange={(e) => setSearchTerm(e.target.value)}
                        className="w-full pl-9 pr-4 py-1.5 border border-gray-300 dark:border-gray-600 rounded-lg text-sm bg-white dark:bg-gray-700 dark:text-white focus:ring-2 focus:ring-indigo-500 outline-none transition-shadow"
                    />
                </div>
            </div>
            
            <div className="text-xs text-gray-500 dark:text-gray-400 font-medium">
                Total recorded: <span className="font-bold text-gray-700 dark:text-gray-200">{pagination.totalRecords}</span>
            </div>
        </div>

        <DataTable
          columns={columns}
          data={logs}
          loading={false}
          selectable={true}
          selectedIds={selectedIds}
          onSelectRow={handleSelectRow}
          onSelectAll={handleSelectAll}
          currentPage={pagination.currentPage}
          totalPages={pagination.totalPages}
          onPageChange={(p) => fetchLogs(p, debouncedSearch)}
          searchable={false}
          customActions={[
            {
              icon: FiCornerUpRight,
              tooltip: "Create Redirect",
              handler: (item) => setConfirmModal({ isOpen: true, type: "redirect", data: item.uri }),
              className: "text-indigo-600 hover:bg-indigo-50 dark:hover:bg-indigo-900/30"
            }
          ]}
          onDelete={(item) => setConfirmModal({ isOpen: true, type: "delete", data: item.id })}
        />
      </div>
    </div>
  );
};

export default Seo404Monitor;