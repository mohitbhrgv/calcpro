<?php
// Include the database configuration file, which has our validation function
require '../../core/config.php';

// Set content type to JSON
header('Content-Type: application/json');

// --- Get the request data ---
$json = file_get_contents('php://input');
$data = json_decode($json);

// --- Validation ---
if (!isset($data->userId) || !isset($data->currentPassword) || !isset($data->newPassword)) {
    echo json_encode(['success' => false, 'message' => 'User ID, current password, and new password are required.']);
    exit();
}

// --- SERVER-SIDE PASSWORD STRENGTH VALIDATION ---
if (!validatePasswordStrength($data->newPassword)) {
    // --- UPDATED: More descriptive error message ---
    echo json_encode(['success' => false, 'message' => 'Password must be at least 8 characters and contain a letter, a number, and a special character.']);
    exit();
}

// --- PREVENT PASSWORD REUSE ---
if ($data->newPassword === $data->currentPassword) {
    echo json_encode(['success' => false, 'message' => 'New password cannot be the same as the old password.']);
    exit();
}

// --- Sanitize Input ---
$userId = (int)$data->userId;
$currentPassword = trim($data->currentPassword);
$newPassword = trim($data->newPassword);

// --- 1. Fetch the user's current hashed password from the database ---
$sql_fetch = "SELECT password FROM users WHERE id = ?";
$stmt_fetch = $conn->prepare($sql_fetch);
$stmt_fetch->bind_param("i", $userId);
$stmt_fetch->execute();
$result = $stmt_fetch->get_result();

if ($result->num_rows === 0) {
    echo json_encode(['success' => false, 'message' => 'User not found.']);
    $stmt_fetch->close();
    $conn->close();
    exit();
}

$user = $result->fetch_assoc();
$hashed_password_from_db = $user['password'];
$stmt_fetch->close();

// --- 2. Verify the provided current password against the stored hash ---
if (!password_verify($currentPassword, $hashed_password_from_db)) {
    echo json_encode(['success' => false, 'message' => 'Incorrect current password.']);
    $conn->close();
    exit();
}

// --- 3. If the current password is correct, hash the new password and update it ---
$new_hashed_password = password_hash($newPassword, PASSWORD_BCRYPT);

$sql_update = "UPDATE users SET password = ? WHERE id = ?";
$stmt_update = $conn->prepare($sql_update);
$stmt_update->bind_param("si", $new_hashed_password, $userId);

if ($stmt_update->execute()) {
    echo json_encode(['success' => true, 'message' => 'Password updated successfully!']);
} else {
    echo json_encode(['success' => false, 'message' => 'Failed to update password. Please try again.']);
}

// --- Close connections ---
$stmt_update->close();
$conn->close();
?>