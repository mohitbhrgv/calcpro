<?php
// Core utilities
require_once '../../core/config.php';
require_once '../../core/response.php';
require_once '../../core/auth.php';

// --- SECURITY CHECK ---
$admin_data = verifyAdminToken();

try {
    // --- 1. Get Incoming Data ---
    $json = file_get_contents('php://input');
    $data = json_decode($json);

    // --- 2. Validation ---
    if (!isset($data->ids) || !is_array($data->ids) || empty($data->ids)) {
        sendResponse(false, null, 'No items selected.', 400, 'INVALID_INPUT');
    }
    if (!isset($data->action)) {
        sendResponse(false, null, 'No action specified.', 400, 'INVALID_INPUT');
    }

    $action = $data->action;
    
    // Sanitize IDs to ensure they are all integers
    $ids = array_map('intval', $data->ids);
    // Convert to comma-separated string for SQL IN clause (Safe because of intval)
    $id_list = implode(',', $ids);

    // --- 3. Execute Action ---
    $sql = "";
    $successMsg = "";

    switch ($action) {
        case 'trash':
            // Soft delete: Move to trash if not already there
            $sql = "UPDATE redirects SET status = 'trash' WHERE id IN ($id_list) AND status != 'trash'";
            $successMsg = "Selected redirects moved to Trash.";
            break;

        case 'delete_permanent':
            // Hard delete: Only if already in trash
            $sql = "DELETE FROM redirects WHERE id IN ($id_list) AND status = 'trash'";
            $successMsg = "Selected redirects permanently deleted.";
            break;

        case 'restore':
            // Restore from trash to active
            $sql = "UPDATE redirects SET status = 'active' WHERE id IN ($id_list) AND status = 'trash'";
            $successMsg = "Selected redirects restored.";
            break;

        case 'activate':
            // Set status to active (only if not in trash)
            $sql = "UPDATE redirects SET status = 'active' WHERE id IN ($id_list) AND status != 'trash'";
            $successMsg = "Selected redirects activated.";
            break;

        case 'deactivate':
            // Set status to inactive (only if not in trash)
            $sql = "UPDATE redirects SET status = 'inactive' WHERE id IN ($id_list) AND status != 'trash'";
            $successMsg = "Selected redirects deactivated.";
            break;

        default:
            sendResponse(false, null, 'Invalid action specified.', 400, 'INVALID_ACTION');
            break;
    }

    // --- 4. Run Query ---
    if ($conn->query($sql) === TRUE) {
         $affected = $conn->affected_rows;
         if ($affected > 0) {
             sendResponse(true, ['affected' => $affected], $successMsg, 200);
         } else {
             sendResponse(false, null, 'No records were updated. They may not meet the criteria for this action.', 404, 'NO_CHANGES');
         }
    } else {
         throw new Exception("Database query failed: " . $conn->error);
    }

} catch (Exception $e) {
    error_log("Error in manage_redirects_bulk.php: " . $e->getMessage());
    sendResponse(false, null, 'An internal server error occurred.', 500, 'SERVER_ERROR');
}

$conn->close();
?>