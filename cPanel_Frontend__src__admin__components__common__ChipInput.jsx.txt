import React, { useState, useEffect, useRef } from "react";
import { motion, AnimatePresence } from "framer-motion";
import SafeIcon from "../../../common/SafeIcon";
import { FiX, FiSearch, FiAlertCircle } from "react-icons/fi";

// --- FIX: Define static constants for default props to prevent re-render loops ---
const EMPTY_ARRAY = [];

/**
 * ChipInput: A smart component for managing lists of items.
 */
const ChipInput = ({ 
  suggestions = EMPTY_ARRAY, // Use static constant
  value = EMPTY_ARRAY,       // Use static constant
  onChange, 
  mode = 'select', 
  placeholder = "Add..." 
}) => {
  const [inputValue, setInputValue] = useState("");
  const [filteredSuggestions, setFilteredSuggestions] = useState([]);
  const [showSuggestions, setShowSuggestions] = useState(false);
  const [highlightedIndex, setHighlightedIndex] = useState(0);
  const wrapperRef = useRef(null);
  const inputRef = useRef(null);

  const getLabel = (item) => {
    if (mode === 'select') {
      const found = suggestions.find(s => s.id === item);
      return found ? found.name : "Unknown Tag";
    }
    return item; 
  };

  // --- SEARCH LOGIC ---
  useEffect(() => {
    // If input is empty, close dropdown
    if (!inputValue.trim()) {
      // Only update state if it actually changes to prevent loops
      setFilteredSuggestions(prev => prev.length === 0 ? prev : []);
      setShowSuggestions(false);
      return;
    }

    const lowerInput = inputValue.toLowerCase();
    let filtered = [];

    if (mode === 'select') {
      // Tags: Search in object array
      filtered = suggestions.filter(
        (tag) =>
          !value.includes(tag.id) && 
          tag.name.toLowerCase().includes(lowerInput)
      );
    } else {
      // Keywords: Search in string array (if provided)
      // Ensure suggestions is iterable before filtering
      if (Array.isArray(suggestions)) {
          filtered = suggestions.filter(
            (str) => 
              !value.includes(str) && 
              str.toLowerCase().includes(lowerInput)
          );
      }
    }
    
    setFilteredSuggestions(filtered);
    setShowSuggestions(true);
    setHighlightedIndex(0); 

  }, [inputValue, suggestions, value, mode]);

  useEffect(() => {
    function handleClickOutside(event) {
      if (wrapperRef.current && !wrapperRef.current.contains(event.target)) {
        setShowSuggestions(false);
      }
    }
    document.addEventListener("mousedown", handleClickOutside);
    return () => document.removeEventListener("mousedown", handleClickOutside);
  }, []);

  const handleAdd = (item) => {
    let newValue;
    if (mode === 'select') {
      newValue = [...value, item.id];
    } else {
      const trimmed = item.trim();
      if (!trimmed || value.includes(trimmed)) return; 
      newValue = [...value, trimmed];
    }
    
    onChange(newValue);
    setInputValue("");
    setShowSuggestions(false);
    inputRef.current?.focus(); 
  };

  const handleRemove = (itemToRemove) => {
    const newValue = value.filter((item) => item !== itemToRemove);
    onChange(newValue);
  };

  const handleKeyDown = (e) => {
    if (e.key === "Enter") {
      e.preventDefault();
      
      // 1. If dropdown is visible and has items, enter selects the highlighted one
      if (showSuggestions && filteredSuggestions.length > 0) {
        handleAdd(filteredSuggestions[highlightedIndex]);
      } 
      // 2. If 'creatable' mode (Keywords) and text exists, add the text
      else if (mode === 'creatable' && inputValue.trim()) {
        handleAdd(inputValue);
      }
    } else if (e.key === "ArrowDown") {
      if (filteredSuggestions.length > 0) {
        e.preventDefault();
        setHighlightedIndex(prev => (prev + 1) % filteredSuggestions.length);
      }
    } else if (e.key === "ArrowUp") {
      if (filteredSuggestions.length > 0) {
        e.preventDefault();
        setHighlightedIndex(prev => (prev - 1 + filteredSuggestions.length) % filteredSuggestions.length);
      }
    } else if (e.key === "Backspace" && !inputValue && value.length > 0) {
      handleRemove(value[value.length - 1]);
    } else if (e.key === "Escape") {
      setShowSuggestions(false);
    }
  };

  // Decision logic for rendering dropdown
  const shouldRenderDropdown = showSuggestions && (mode === 'select' || filteredSuggestions.length > 0);

  // Dynamic width style calculation
  const dynamicWidth = value.length === 0 && !inputValue 
      ? "100%" 
      : `${Math.max(inputValue.length + 1, 3)}ch`; 

  return (
    <div className="relative group" ref={wrapperRef}>
      <div 
        className="flex flex-wrap gap-2 p-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800 focus-within:ring-2 focus-within:ring-blue-500 transition-shadow cursor-text"
        onClick={() => inputRef.current?.focus()}
      >
        {value.map((item, index) => (
          <motion.span
            key={index}
            initial={{ opacity: 0, scale: 0.8 }}
            animate={{ opacity: 1, scale: 1 }}
            className="flex items-center gap-1 bg-blue-100 dark:bg-blue-900/40 text-blue-800 dark:text-blue-300 text-xs font-medium px-2.5 py-1 rounded-full border border-blue-200 dark:border-blue-800 whitespace-nowrap"
          >
            {getLabel(item)}
            <button
              type="button"
              onClick={(e) => { e.stopPropagation(); handleRemove(item); }}
              className="p-0.5 rounded-full hover:bg-blue-200 dark:hover:bg-blue-700 focus:outline-none transition-colors"
            >
              <SafeIcon icon={FiX} className="w-3 h-3" />
            </button>
          </motion.span>
        ))}
        
        <input
          ref={inputRef}
          type="text"
          value={inputValue}
          onChange={(e) => setInputValue(e.target.value)}
          onKeyDown={handleKeyDown}
          onFocus={() => { if(inputValue) setShowSuggestions(true); }}
          placeholder={value.length === 0 ? placeholder : ""}
          className="bg-transparent focus:outline-none text-sm text-gray-900 dark:text-white placeholder-gray-400 h-7"
          style={{ 
              width: dynamicWidth,
              minWidth: "40px",
              maxWidth: "100%" 
          }}
        />
      </div>

      <AnimatePresence>
        {shouldRenderDropdown && (
          <motion.div
            initial={{ opacity: 0, y: 5 }}
            animate={{ opacity: 1, y: 0 }}
            exit={{ opacity: 0, y: 5 }}
            className="absolute left-0 right-0 z-50 w-full mt-1 bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg shadow-xl overflow-hidden"
          >
            {filteredSuggestions.length > 0 ? (
              <ul className="max-h-48 overflow-y-auto py-1">
                {filteredSuggestions.map((suggestion, index) => (
                  <li
                    key={mode === 'select' ? suggestion.id : index}
                    onClick={() => handleAdd(suggestion)}
                    onMouseEnter={() => setHighlightedIndex(index)}
                    className={`px-4 py-2 text-sm cursor-pointer flex items-center gap-2 transition-colors ${
                      index === highlightedIndex 
                        ? "bg-blue-50 dark:bg-blue-900/30 text-blue-700 dark:text-blue-300" 
                        : "text-gray-700 dark:text-gray-200 hover:bg-gray-50 dark:hover:bg-gray-700"
                    }`}
                  >
                    <SafeIcon icon={FiSearch} className={`w-3.5 h-3.5 ${index === highlightedIndex ? "opacity-100" : "opacity-40"}`} />
                    {mode === 'select' ? suggestion.name : suggestion}
                  </li>
                ))}
              </ul>
            ) : (
              <div className="px-4 py-3 text-sm text-gray-500 dark:text-gray-400 flex items-center gap-2">
                <SafeIcon icon={FiAlertCircle} className="w-4 h-4" />
                <span>No matching items found.</span>
              </div>
            )}
          </motion.div>
        )}
      </AnimatePresence>
    </div>
  );
};

export default ChipInput;