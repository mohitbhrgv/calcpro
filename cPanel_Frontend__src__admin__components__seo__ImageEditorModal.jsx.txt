import React, { useState, useEffect } from "react";
import Modal from "../common/Modal";
import SafeIcon from "@/common/SafeIcon";
import * as FiIcons from "react-icons/fi";

const {
  FiSave,
  FiFileText,
  FiImage,
  FiType,
  FiMaximize,
  FiGlobe,
  FiClipboard,
} = FiIcons;

const DetailRow = ({ icon, label, value, isUrl = false }) => (
  <div className="flex items-start text-sm py-1.5">
    <SafeIcon
      icon={icon}
      className="w-4 h-4 text-gray-500 dark:text-gray-400 mr-3 mt-0.5 flex-shrink-0"
    />
    <span className="font-medium text-gray-700 dark:text-gray-300 w-24 flex-shrink-0">
      {label}:
    </span>
    {isUrl ? (
      <div className="flex items-center gap-2 flex-1 min-w-0">
        <input
          type="text"
          readOnly
          value={value}
          className="w-full bg-transparent text-gray-900 dark:text-white truncate p-0 border-none focus:ring-0"
        />
        <button
          onClick={() => {
            navigator.clipboard.writeText(value);
            toast.success("URL copied!");
          }}
          className="p-1 rounded-md hover:bg-gray-200 dark:hover:bg-gray-600"
        >
          <SafeIcon icon={FiClipboard} className="w-3 h-3" />
        </button>
      </div>
    ) : (
      <span className="text-gray-900 dark:text-white break-words">{value}</span>
    )}
  </div>
);

const ImageEditorModal = ({
  isOpen,
  onClose,
  imageData,
  onSave,
  isSubmitting,
}) => {
  const [altText, setAltText] = useState("");

  useEffect(() => {
    if (imageData) {
      setAltText(imageData.alt || "");
    }
  }, [imageData]);

  if (!imageData) {
    return null;
  }

  const handleSave = () => {
    onSave(altText);
  };

  const formatFileSize = (bytes) => {
    if (!bytes || bytes === 0) return "N/A";
    const k = 1024;
    const sizes = ["Bytes", "KB", "MB", "GB", "TB"];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + " " + sizes[i];
  };

  return (
    <Modal
      isOpen={isOpen}
      onClose={onClose}
      title="Edit Image Details"
      size="lg"
      zIndexClass="z-[70]"
    >
      <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
        <div className="bg-gray-100 dark:bg-gray-700 rounded-lg flex items-center justify-center p-4">
          <img
            src={imageData.src}
            alt={altText || "Image preview"}
            className="max-w-full max-h-64 object-contain rounded"
          />
        </div>

        <div className="space-y-4">
          <div>
            <label
              htmlFor="instanceAltText"
              className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2"
            >
              Alternative Text (Alt Text)
            </label>
            <textarea
              id="instanceAltText"
              value={altText}
              onChange={(e) => setAltText(e.target.value)}
              rows={3}
              className="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-calcpro-primary focus:border-transparent dark:bg-gray-700 dark:text-white"
              placeholder="Describe the purpose of the image"
            />
            <p className="text-xs text-gray-500 dark:text-gray-400 mt-1">
              This will update the alt text for this image everywhere it appears
              on the site.
            </p>
          </div>

          {imageData.metadata && (
            <div className="space-y-1 pt-2 border-t border-gray-200 dark:border-gray-700">
              <h4 className="font-semibold text-gray-800 dark:text-gray-200 mb-1">
                Original File Metadata
              </h4>
              <DetailRow
                icon={FiFileText}
                label="File Name"
                value={imageData.metadata.file_name}
              />
              {/* --- THIS IS THE FIX --- */}
              <DetailRow
                icon={FiGlobe}
                label="File URL"
                value={imageData.metadata.full_url}
                isUrl={true}
              />
              <DetailRow
                icon={FiType}
                label="File Type"
                value={imageData.metadata.file_type}
              />
              <DetailRow
                icon={FiMaximize}
                label="File Size"
                value={formatFileSize(imageData.metadata.file_size)}
              />
              {imageData.metadata.dimensions && (
                <DetailRow
                  icon={FiImage}
                  label="Dimensions"
                  value={`${imageData.metadata.dimensions.replace(
                    "x",
                    " Ã— "
                  )} pixels`}
                />
              )}
            </div>
          )}

          <div className="flex justify-end pt-4 space-x-3">
            <button
              type="button"
              onClick={onClose}
              className="px-4 py-2 text-gray-700 dark:text-gray-300 border border-gray-300 dark:border-gray-600 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700"
            >
              Cancel
            </button>
            <button
              onClick={handleSave}
              disabled={isSubmitting}
              className="flex items-center space-x-2 bg-calcpro-primary text-white px-4 py-2 rounded-lg hover:bg-calcpro-primary/90 transition-colors"
            >
              <SafeIcon icon={FiSave} className="w-4 h-4" />
              <span>{isSubmitting ? "Saving..." : "Save Changes"}</span>
            </button>
          </div>
        </div>
      </div>
    </Modal>
  );
};

export default ImageEditorModal;
