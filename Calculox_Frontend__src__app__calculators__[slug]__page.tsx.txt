import { Metadata } from "next";
import { notFound } from "next/navigation";
import { 
  getCalculatorBySlug, 
  getPublicCalculators, 
  getSiteSettings 
} from "@/lib/content";
import { constructMetadata } from "@/lib/seo"; // Using shared SEO helper
import CalculatorClientPage from "./client";
import BreadcrumbSchema from "@/components/seo/schemas/BreadcrumbSchema"; // <--- IMPORTED

export async function generateStaticParams() {
  const calculators = await getPublicCalculators();
  return calculators.map((calc) => ({
    slug: calc.slug,
  }));
}

export const revalidate = 60;

interface PageProps {
    params: Promise<{ slug: string }>;
}

export async function generateMetadata({ params }: PageProps): Promise<Metadata> {
  const { slug } = await params;
  
  const calculator = await getCalculatorBySlug(slug);
  const settings = await getSiteSettings();
  
  if (!calculator) {
    return { title: "Calculator Not Found" };
  }

  return constructMetadata({
      data: calculator,
      settings,
      type: "calculator",
      path: `/calculators/${slug}`
  });
}

export default async function CalculatorPage({ params }: PageProps) {
  const { slug } = await params;

  const [calculator, allCalculators, settings] = await Promise.all([
      getCalculatorBySlug(slug),
      getPublicCalculators(),
      getSiteSettings()
  ]);

  if (!calculator) {
    notFound();
  }

  // --- PREPARE DATA FOR SCHEMA ---
  const breadcrumbData = {
      title: calculator.name,
      primary_category_name: calculator.category_names?.split('||')[0],
      primary_category_slug: calculator.category_slugs?.split('||')[0]
  };

  return (
    <>
      {/* --- ADDED BREADCRUMB SCHEMA --- */}
      <BreadcrumbSchema 
          data={breadcrumbData} 
          settings={settings} 
          currentPath={`/calculators/${slug}`} 
      />

      <CalculatorClientPage 
        calculator={calculator} 
        allCalculators={allCalculators} 
        settings={settings}
      />
    </>
  );
}