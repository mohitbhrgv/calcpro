<?php
// Use the PHPMailer classes
use PHPMailer\PHPMailer\PHPMailer;
use PHPMailer\PHPMailer\Exception;

// Core utilities. config.php already handles the Composer autoloader and error reporting.
require_once dirname(__DIR__, 2) . '/core/config.php';
require_once dirname(__DIR__, 2) . '/core/response.php';

// This is a public-facing admin utility, so no JWT check is needed here.

try {
    // --- 1. Get Incoming Data ---
    $json = file_get_contents('php://input');
    $data = json_decode($json);

    // --- 2. Validation ---
    if (!isset($data->email) || !filter_var(trim($data->email), FILTER_VALIDATE_EMAIL)) {
        sendResponse(false, null, 'A valid email address is required.', 400, 'INVALID_INPUT');
    }

    $email = trim($data->email);

    // --- 3. Find the Admin Account ---
    $sql_find = "SELECT id, name, email FROM admins WHERE email = ?";
    $stmt_find = $conn->prepare($sql_find);
    $stmt_find->bind_param("s", $email);
    $stmt_find->execute();
    $result = $stmt_find->get_result();
    
    if ($result->num_rows > 0) {
        $admin = $result->fetch_assoc();
        $stmt_find->close();

        // --- 4. Generate and Store Secure Token (ONLY if user exists) ---
        $token = bin2hex(random_bytes(32)); 
        $token_hash = hash('sha256', $token);
        $expiry_date = date('Y-m-d H:i:s', time() + 3600); // 1 hour

        $sql_update = "UPDATE admins SET reset_token = ?, reset_token_expires_at = ? WHERE id = ?";
        $stmt_update = $conn->prepare($sql_update);
        $stmt_update->bind_param("ssi", $token_hash, $expiry_date, $admin['id']);
        
        if (!$stmt_update->execute()) {
            throw new Exception("Database token update failed: " . $stmt_update->error);
        }
        $stmt_update->close();

        // --- 5. Send the Password Reset Email ---
        // --- THIS IS THE FIX: Use the correct environment variable for the admin URL ---
        $reset_link = rtrim($_ENV['ADMIN_FRONTEND_URL'], '/') . "/#/admin/reset-password/" . $token;

        $subject = 'CalcPro Admin Password Reset Request';
        $htmlBody = "
            <p>Hello {$admin['name']},</p>
            <p>A password reset was requested for your CalcPro administrator account. If you did not make this request, please ignore this email.</p>
            <p>To set a new password, please click the link below:</p>
            <p><a href='{$reset_link}' style='display: inline-block; padding: 12px 24px; font-size: 16px; color: #ffffff; background-color: #1e40af; text-decoration: none; border-radius: 5px;'>Reset Your Password</a></p>
            <p>This link is valid for 1 hour.</p>
            <p>Thanks,<br>The CalcPro Team</p>
        ";
        $altBody = "Hello {$admin['name']},\n\nYou requested a password reset for your CalcPro admin account. Copy and paste this URL into your browser to proceed: {$reset_link}\n\nThis link is valid for 1 hour.";

        if (!sendSecurityEmail($admin['email'], $admin['name'], $subject, $htmlBody, $altBody)) {
            // Even if email fails, we don't expose that to the user for security. Log it instead.
            error_log("Failed to send password reset email to {$admin['email']}.");
        }
    }
    
    // --- 6. Send Final Generic Response ---
    // This is executed for BOTH cases (user found or not found) for security.
    sendResponse(true, null, 'If an account with that email exists, a password reset link has been sent.');

} catch (Exception $e) {
    error_log("Error in request_admin_password_reset.php: " . $e->getMessage());
    sendResponse(false, null, 'An internal server error occurred.', 500, 'SERVER_ERROR');
}

$conn->close();