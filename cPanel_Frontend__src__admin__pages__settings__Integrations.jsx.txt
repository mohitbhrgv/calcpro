import React, { useState, useEffect, useCallback, useMemo } from "react";
import { motion, AnimatePresence } from "framer-motion";
import SafeIcon from "../../../common/SafeIcon";
import * as FiIcons from "react-icons/fi";
import { authenticatedFetch } from "../../utils/apiService";
import toast from "react-hot-toast";
import LoadingSpinner from "../../components/common/LoadingSpinner";
import Modal from "../../components/common/Modal";
import Toggle from "../../components/seo/common/Toggle"; 
import { useAdminCache } from "../../context/AdminCacheContext";
import SettingsHelpModal from "../../components/help/SettingsHelpModal";

const {
  FiSave,
  FiCpu,
  FiCode,
  FiAlertTriangle,
  FiCheckCircle,
  FiActivity,
  FiSearch,
  FiPlus,
  FiTrash2,
  FiEdit2,
  FiInfo
} = FiIcons;

// --- Sub-Component: Script Manager ---
const ScriptManager = ({ title, scripts, onChange, onEdit }) => {
  const toggleScript = (id) => {
    const updated = scripts.map(s => s.id === id ? { ...s, enabled: !s.enabled } : s);
    onChange(updated);
  };

  const deleteScript = (id) => {
    if(!window.confirm("Delete this script?")) return;
    const updated = scripts.filter(s => s.id !== id);
    onChange(updated);
  };

  return (
    <div className="mb-6 last:mb-0">
      <div className="flex items-center justify-between mb-3">
        <label className="text-xs font-bold text-gray-500 dark:text-gray-400 uppercase tracking-wider">
            {title}
        </label>
        <button 
            onClick={() => onEdit(null)} 
            className="text-xs flex items-center gap-1 text-blue-600 hover:text-blue-700 dark:text-blue-400 dark:hover:text-blue-300 font-bold transition-colors"
        >
            <SafeIcon icon={FiPlus} className="w-3 h-3" /> Add Script
        </button>
      </div>

      <div className="space-y-2">
        {scripts.length === 0 && (
            <div className="p-4 border-2 border-dashed border-gray-200 dark:border-gray-700 rounded-lg text-center">
                <span className="text-xs text-gray-400 block">No scripts added yet.</span>
            </div>
        )}
        
        <AnimatePresence>
            {scripts.map((script) => (
                <motion.div 
                    key={script.id}
                    initial={{ opacity: 0, y: 5 }}
                    animate={{ opacity: 1, y: 0 }}
                    exit={{ opacity: 0, scale: 0.95 }}
                    className="flex items-center justify-between p-3 bg-gray-50 dark:bg-gray-900 border border-gray-200 dark:border-gray-700 rounded-lg group hover:border-blue-300 dark:hover:border-blue-700 transition-colors"
                >
                    <div className="flex items-center gap-3 overflow-hidden">
                        <div className={`w-2 h-2 rounded-full flex-shrink-0 ${script.enabled ? 'bg-green-500' : 'bg-gray-300 dark:bg-gray-600'}`} />
                        <span className="text-sm font-medium text-gray-700 dark:text-gray-200 truncate max-w-[150px]" title={script.name}>
                            {script.name}
                        </span>
                    </div>
                    
                    <div className="flex items-center gap-3">
                        <Toggle checked={script.enabled} onChange={() => toggleScript(script.id)} />
                        
                        <div className="flex items-center gap-1 opacity-0 group-hover:opacity-100 transition-opacity">
                             <button 
                                onClick={() => onEdit(script)}
                                className="p-1.5 text-gray-500 hover:text-blue-600 hover:bg-white dark:hover:bg-gray-800 rounded-md transition-colors"
                             >
                                 <SafeIcon icon={FiEdit2} className="w-3.5 h-3.5" />
                             </button>
                             <button 
                                onClick={() => deleteScript(script.id)}
                                className="p-1.5 text-gray-500 hover:text-red-600 hover:bg-white dark:hover:bg-gray-800 rounded-md transition-colors"
                             >
                                 <SafeIcon icon={FiTrash2} className="w-3.5 h-3.5" />
                             </button>
                        </div>
                    </div>
                </motion.div>
            ))}
        </AnimatePresence>
      </div>
    </div>
  );
};

const Integrations = () => {
  const { getCache, setCacheData, isInitialLoadComplete } = useAdminCache();
  const cacheKey = "settings_general";
  const cachedData = getCache(cacheKey);

  const [loading, setLoading] = useState(!cachedData);
  const [isSubmitting, setIsSubmitting] = useState(false);
  
  // Modals
  const [showConfirmModal, setShowConfirmModal] = useState(false);
  const [confirmInput, setConfirmInput] = useState("");
  const [showScriptModal, setShowScriptModal] = useState(false);
  
  const [isHelpOpen, setIsHelpOpen] = useState(false);

  const [editingScript, setEditingScript] = useState(null); 
  const [targetSection, setTargetSection] = useState(null); 
  const [scriptForm, setScriptForm] = useState({ name: "", code: "" });

  const parseScripts = (val) => {
    if (!val) return [];
    try {
        const parsed = JSON.parse(val);
        if (Array.isArray(parsed)) return parsed;
        if (val.trim()) return [{ id: Date.now(), name: 'Legacy Script', code: val, enabled: true }];
        return [];
    } catch {
        if (val.trim()) return [{ id: Date.now(), name: 'Legacy Script', code: val, enabled: true }];
        return [];
    }
  };

  const parseSettings = (data) => ({
    integration_ga4_id: data.integration_ga4_id || "",
    integration_gsc_code: data.integration_gsc_code || "",
    headerScripts: parseScripts(data.integration_header_scripts),
    footerScripts: parseScripts(data.integration_footer_scripts)
  });

  const [settings, setSettings] = useState(
    cachedData ? parseSettings(cachedData) : parseSettings({})
  );
  
  const [initialSettings, setInitialSettings] = useState(
    cachedData ? parseSettings(cachedData) : parseSettings({})
  );

  const hasChanges = useMemo(() => {
    return JSON.stringify(settings) !== JSON.stringify(initialSettings);
  }, [settings, initialSettings]);

  const fetchSettings = useCallback(async (forceRefresh = false) => {
    if (!forceRefresh && getCache(cacheKey)) {
        setLoading(false);
        return;
    }
    try {
        const result = await authenticatedFetch("http://localhost/calcpro-api/api/admin/get_settings.php");
        if (result.success) {
            const data = parseSettings(result.data);
            setSettings(data);
            setInitialSettings(data);
            setCacheData(cacheKey, result.data);
        }
    } catch (error) {
        toast.error("Failed to load integration settings.");
    } finally {
        setLoading(false);
    }
  }, [getCache, setCacheData, cacheKey]);

  useEffect(() => {
    fetchSettings();
  }, [fetchSettings]);

  const handleChange = (e) => {
    const { name, value } = e.target;
    setSettings((prev) => ({ ...prev, [name]: value }));
  };

  const openScriptModal = (section, script) => {
      setTargetSection(section);
      setEditingScript(script);
      setScriptForm({
          name: script ? script.name : "",
          code: script ? script.code : ""
      });
      setShowScriptModal(true);
  };

  const handleScriptSave = (e) => {
      e.preventDefault();
      if (!scriptForm.name.trim() || !scriptForm.code.trim()) {
          toast.error("Name and Code are required.");
          return;
      }

      const newScript = {
          id: editingScript ? editingScript.id : Date.now(),
          name: scriptForm.name,
          code: scriptForm.code,
          enabled: editingScript ? editingScript.enabled : true
      };

      setSettings(prev => {
          const listKey = targetSection === 'header' ? 'headerScripts' : 'footerScripts';
          const currentList = [...prev[listKey]];
          
          if (editingScript) {
              const idx = currentList.findIndex(s => s.id === editingScript.id);
              if (idx !== -1) currentList[idx] = newScript;
          } else {
              currentList.push(newScript);
          }
          
          return { ...prev, [listKey]: currentList };
      });
      
      setShowScriptModal(false);
  };

  const handleScriptListChange = (section, newList) => {
      setSettings(prev => ({
          ...prev,
          [section === 'header' ? 'headerScripts' : 'footerScripts']: newList
      }));
  };

  const initiateSave = () => {
    const headerChanged = JSON.stringify(settings.headerScripts) !== JSON.stringify(initialSettings.headerScripts);
    const footerChanged = JSON.stringify(settings.footerScripts) !== JSON.stringify(initialSettings.footerScripts);

    if (headerChanged || footerChanged) {
        setConfirmInput("");
        setShowConfirmModal(true);
    } else {
        executeSave();
    }
  };

  const executeSave = async () => {
    setShowConfirmModal(false);
    setIsSubmitting(true);
    
    if (settings.integration_ga4_id && !/^G-[A-Z0-9]+$/.test(settings.integration_ga4_id)) {
        toast.error("Invalid GA4 ID format.");
        setIsSubmitting(false);
        return;
    }

    const payload = {
        integration_ga4_id: settings.integration_ga4_id,
        integration_gsc_code: settings.integration_gsc_code,
        integration_header_scripts: JSON.stringify(settings.headerScripts),
        integration_footer_scripts: JSON.stringify(settings.footerScripts)
    };

    try {
      const result = await authenticatedFetch(
        "http://localhost/calcpro-api/api/admin/update_settings.php",
        { method: "POST", body: JSON.stringify(payload) }
      );

      if (result.success) {
        toast.success("Integrations updated successfully!");
        setInitialSettings(settings);
        const cachePayload = { ...payload, ...result.data };
        const currentCache = getCache(cacheKey) || {};
        setCacheData(cacheKey, { ...currentCache, ...cachePayload });
      } else {
        toast.error(result.message || "Failed to save.");
      }
    } catch (error) {
      toast.error("Connection failed.");
    } finally {
      setIsSubmitting(false);
    }
  };

  if (!isInitialLoadComplete && loading) return <LoadingSpinner size="xl" className="h-64" />;

  return (
    <div className="space-y-6 pb-10">
      
      {/* --- Settings Help Modal (Updated with disableAnimation) --- */}
      <SettingsHelpModal
        isOpen={isHelpOpen}
        onClose={() => setIsHelpOpen(false)}
        section="integrations"
        disableAnimation={true} // --- PROP PASSED ---
      />

      {/* Script Edit Modal (Updated with disableAnimation) */}
      <Modal
         isOpen={showScriptModal}
         onClose={() => setShowScriptModal(false)}
         title={editingScript ? "Edit Script" : "Add New Script"}
         size="lg"
         disableAnimation={true} // --- PROP PASSED ---
      >
          <form onSubmit={handleScriptSave} className="space-y-5">
              <div>
                  <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1.5">Script Name</label>
                  <input 
                    type="text" 
                    value={scriptForm.name}
                    onChange={e => setScriptForm(prev => ({...prev, name: e.target.value}))}
                    placeholder="e.g. Facebook Pixel"
                    className="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg dark:bg-gray-700 dark:text-white outline-none focus:ring-2 focus:ring-blue-500"
                    autoFocus
                  />
              </div>
              <div>
                  <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1.5">Script Code</label>
                  <div className="relative border border-gray-300 dark:border-gray-600 rounded-lg overflow-hidden focus-within:ring-2 focus-within:ring-blue-500">
                     <textarea 
                        value={scriptForm.code}
                        onChange={e => setScriptForm(prev => ({...prev, code: e.target.value}))}
                        rows={10}
                        className="w-full p-3 font-mono text-xs bg-gray-50 dark:bg-gray-900 border-none outline-none text-gray-800 dark:text-gray-200 resize-none block"
                        placeholder="<script>...</script>"
                        spellCheck="false"
                      />
                  </div>
                  <p className="text-xs text-gray-500 mt-1">
                      Paste the raw HTML code here. It will be injected exactly as written.
                  </p>
              </div>
              <div className="flex justify-end gap-3 pt-2">
                  <button type="button" onClick={() => setShowScriptModal(false)} className="px-4 py-2 text-gray-600 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg">Cancel</button>
                  <button type="submit" className="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-medium">
                      {editingScript ? "Update Script" : "Add Script"}
                  </button>
              </div>
          </form>
      </Modal>

      {/* Deploy Confirmation Modal (Updated with disableAnimation) */}
      <Modal
        isOpen={showConfirmModal}
        onClose={() => setShowConfirmModal(false)}
        title="Deploy Script Changes"
        type="warning"
        size="md"
        disableAnimation={true} // --- PROP PASSED ---
      >
         <div className="space-y-4">
             <div className="bg-amber-50 dark:bg-amber-900/20 p-4 rounded-lg border border-amber-200 dark:border-amber-800 flex items-start gap-3">
                 <SafeIcon icon={FiAlertTriangle} className="w-6 h-6 text-amber-600 shrink-0 mt-0.5" />
                 <div>
                     <h4 className="text-sm font-bold text-amber-900 dark:text-amber-100">Active Code Modification</h4>
                     <p className="text-xs text-amber-800 dark:text-amber-200/80 mt-1">
                         You are modifying scripts that run on the live website. Malformed code can break site functionality.
                     </p>
                 </div>
             </div>
             <div>
                 <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                     Type <strong>DEPLOY</strong> to confirm:
                 </label>
                 <input 
                    type="text"
                    value={confirmInput}
                    onChange={(e) => setConfirmInput(e.target.value)}
                    className="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md focus:ring-2 focus:ring-amber-500 dark:bg-gray-700 dark:text-white"
                    placeholder="DEPLOY"
                 />
             </div>
             <div className="flex justify-end gap-3 pt-2">
                 <button onClick={() => setShowConfirmModal(false)} className="px-4 py-2 text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg">Cancel</button>
                 <button 
                    onClick={executeSave}
                    disabled={confirmInput !== "DEPLOY"}
                    className="px-4 py-2 bg-amber-600 text-white rounded-lg hover:bg-amber-700 disabled:opacity-50 font-medium"
                 >
                     Deploy
                 </button>
             </div>
         </div>
      </Modal>

      {/* Main Header */}
      <div className="flex items-start gap-4 p-4 rounded-lg bg-indigo-50 dark:bg-indigo-900/20 border border-indigo-100 dark:border-indigo-800/50">
        <div className="p-2 bg-indigo-100 dark:bg-indigo-800 rounded-lg text-indigo-600 dark:text-indigo-300 shrink-0">
          <SafeIcon icon={FiCpu} className="w-5 h-5" />
        </div>
        <div>
          <div className="flex items-center gap-2">
              <h4 className="font-bold text-gray-900 dark:text-white">Integrations & Scripts</h4>
              {/* --- NEW: Info Button --- */}
              <button
                onClick={() => setIsHelpOpen(true)}
                className="text-gray-400 hover:text-indigo-600 dark:hover:text-indigo-400 transition-colors p-1 rounded-full hover:bg-indigo-50 dark:hover:bg-indigo-900/30"
                title="Configuration Guide"
              >
                <SafeIcon icon={FiInfo} className="w-4 h-4" />
              </button>
          </div>
          <p className="text-sm text-gray-600 dark:text-gray-300 mt-1 leading-relaxed">
            Manage third-party services and inject custom code snippets safely.
          </p>
        </div>
      </div>

      <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
          
          {/* LEFT: Google Services */}
          <div className="space-y-6">
              <div className="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 overflow-hidden">
                  <div className="px-6 py-4 border-b border-gray-100 dark:border-gray-700 bg-gray-50/50 dark:bg-gray-800/50 flex items-center gap-2">
                      <SafeIcon icon={FiActivity} className="text-orange-500" />
                      <h3 className="font-bold text-gray-900 dark:text-white">Google Services</h3>
                  </div>
                  <div className="p-6 space-y-6">
                      <div>
                          <label className="block text-sm font-bold text-gray-700 dark:text-gray-300 mb-1.5">
                              Google Analytics 4 (GA4)
                          </label>
                          <div className="relative">
                              <input 
                                  type="text"
                                  name="integration_ga4_id"
                                  value={settings.integration_ga4_id}
                                  onChange={handleChange}
                                  placeholder="G-XXXXXXXXXX"
                                  className="w-full pl-4 pr-10 py-2 border border-gray-300 dark:border-gray-600 rounded-lg dark:bg-gray-700 dark:text-white focus:ring-2 focus:ring-orange-500 outline-none font-mono text-sm"
                              />
                              <div className="absolute right-3 top-1/2 -translate-y-1/2 text-gray-400">
                                  {settings.integration_ga4_id && <SafeIcon icon={FiCheckCircle} className="text-green-500 w-4 h-4" />}
                              </div>
                          </div>
                      </div>

                      <div>
                          <label className="block text-sm font-bold text-gray-700 dark:text-gray-300 mb-1.5">
                              Google Search Console
                          </label>
                          <div className="relative">
                              <div className="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400">
                                  <SafeIcon icon={FiSearch} className="w-4 h-4" />
                              </div>
                              <input 
                                  type="text"
                                  name="integration_gsc_code"
                                  value={settings.integration_gsc_code}
                                  onChange={handleChange}
                                  placeholder="Verification Code"
                                  className="w-full pl-9 pr-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg dark:bg-gray-700 dark:text-white focus:ring-2 focus:ring-blue-500 outline-none font-mono text-sm"
                              />
                          </div>
                      </div>
                  </div>
              </div>
          </div>

          {/* RIGHT: Custom Script Manager */}
          <div className="space-y-6">
              <div className="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 overflow-hidden">
                  <div className="px-6 py-4 border-b border-gray-100 dark:border-gray-700 bg-gray-50/50 dark:bg-gray-800/50 flex items-center justify-between">
                      <div className="flex items-center gap-2">
                          <SafeIcon icon={FiCode} className="text-purple-500" />
                          <h3 className="font-bold text-gray-900 dark:text-white">Script Manager</h3>
                      </div>
                      <span className="text-[10px] font-bold bg-purple-100 text-purple-700 px-2 py-0.5 rounded uppercase">Advanced</span>
                  </div>
                  
                  <div className="p-6">
                      <ScriptManager 
                          title="Header Scripts (<head>)" 
                          scripts={settings.headerScripts} 
                          onChange={(newList) => handleScriptListChange('header', newList)}
                          onEdit={(script) => openScriptModal('header', script)}
                      />
                      
                      <div className="my-6 border-t border-gray-100 dark:border-gray-700" />
                      
                      <ScriptManager 
                          title="Footer Scripts (</body>)" 
                          scripts={settings.footerScripts} 
                          onChange={(newList) => handleScriptListChange('footer', newList)}
                          onEdit={(script) => openScriptModal('footer', script)}
                      />
                  </div>
              </div>
          </div>

      </div>

      <div className="flex justify-end pt-4">
        <motion.button
          whileHover={hasChanges ? { scale: 1.02 } : {}}
          whileTap={hasChanges ? { scale: 0.98 } : {}}
          onClick={initiateSave}
          disabled={isSubmitting || !hasChanges}
          className={`flex items-center space-x-2 px-6 py-3 rounded-lg shadow-sm font-bold transition-all ${
            hasChanges
              ? "bg-indigo-600 text-white hover:bg-indigo-700"
              : "bg-gray-200 dark:bg-gray-700 text-gray-500 dark:text-gray-400 cursor-not-allowed"
          }`}
        >
            {isSubmitting ? (
                 <LoadingSpinner size="sm" color="white" />
            ) : (
                 <SafeIcon icon={FiSave} className="w-5 h-5" />
            )}
          <span>{isSubmitting ? "Saving..." : "Save Configuration"}</span>
        </motion.button>
      </div>

    </div>
  );
};

export default Integrations;