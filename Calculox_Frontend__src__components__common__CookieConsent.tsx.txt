"use client";

import React, { useState, useEffect } from 'react';
import { motion, AnimatePresence } from 'framer-motion';
import Link from 'next/link';
import SafeIcon from '@/components/common/SafeIcon';
import * as FiIcons from 'react-icons/fi';
import toast from 'react-hot-toast';

const { FiX, FiSettings } = FiIcons;

interface CookiePreferences {
  essential: boolean;
  analytics: boolean;
  marketing: boolean;
  functional: boolean;
}

const CookieConsent = () => {
  const [showConsent, setShowConsent] = useState(false);
  const [showSettings, setShowSettings] = useState(false);
  const [cookiePreferences, setCookiePreferences] = useState<CookiePreferences>({
    essential: true, // Always true and disabled
    analytics: false,
    marketing: false,
    functional: false
  });
  
  // Prevent hydration mismatch by waiting for mount
  const [mounted, setMounted] = useState(false);

  useEffect(() => {
    setMounted(true);
    // Check if user has already made a choice
    const consent = localStorage.getItem('cookieConsent');
    const savedPreferences = localStorage.getItem('cookiePreferences');
    
    if (consent && savedPreferences) {
      setCookiePreferences(JSON.parse(savedPreferences));
    } else {
      // Small delay to show animation smoothly after load
      const timer = setTimeout(() => setShowConsent(true), 1000);
      return () => clearTimeout(timer);
    }
  }, []);

  const handleAcceptAll = () => {
    const preferences = {
      essential: true,
      analytics: true,
      marketing: true,
      functional: true
    };
    savePreferences(preferences);
  };

  const handleDecline = () => {
    const preferences = {
      essential: true,
      analytics: false,
      marketing: false,
      functional: false
    };
    savePreferences(preferences);
  };

  const handleSaveSettings = () => {
    savePreferences(cookiePreferences);
  };

  const savePreferences = (preferences: CookiePreferences) => {
    // Save to localStorage
    localStorage.setItem('cookieConsent', 'set');
    localStorage.setItem('cookiePreferences', JSON.stringify(preferences));
    
    // Apply preferences (Hook for analytics scripts usually goes here)
    console.log('[CookieConsent] Preferences saved:', preferences);

    setShowSettings(false);
    setShowConsent(false);
    
    toast.success('Cookie preferences saved successfully');
  };

  const handleTogglePreference = (key: keyof CookiePreferences) => {
    if (key === 'essential') return; // Essential cookies cannot be disabled
    setCookiePreferences(prev => ({
      ...prev,
      [key]: !prev[key]
    }));
  };

  if (!mounted) return null;

  return (
    <AnimatePresence>
      {showConsent && (
        <motion.div
          initial={{ y: 100, opacity: 0 }}
          animate={{ y: 0, opacity: 1 }}
          exit={{ y: 100, opacity: 0 }}
          className="fixed bottom-4 left-4 right-4 z-[9999] max-w-md mx-auto sm:mx-0 sm:left-6"
        >
          <div className="bg-white dark:bg-neutral-800 rounded-xl shadow-2xl border border-neutral-200 dark:border-neutral-700 p-6">
            {/* Cookie Consent Content */}
            <div className="flex items-start justify-between mb-4">
              <h3 className="text-lg font-semibold text-neutral-900 dark:text-white">
                Cookie Settings
              </h3>
              <button
                onClick={() => setShowConsent(false)}
                className="text-neutral-500 hover:text-neutral-700 dark:text-neutral-400 dark:hover:text-neutral-200"
              >
                <SafeIcon icon={FiX} className="w-5 h-5" />
              </button>
            </div>
            
            <p className="text-sm text-neutral-600 dark:text-neutral-400 mb-5 leading-relaxed">
              We use cookies to enhance your experience and analyze our traffic. 
              These cookies help us understand how our website is being used and improve your experience.
            </p>

            <div className="flex flex-col gap-3">
              <div className="flex gap-3">
                <button
                    onClick={handleAcceptAll}
                    className="flex-1 bg-gradient-to-r from-indigo-600 to-violet-600 text-white px-4 py-2.5 rounded-lg hover:from-indigo-700 hover:to-violet-700 transition-all duration-200 font-medium text-sm shadow-sm"
                >
                    Accept All
                </button>
                <button
                    onClick={handleDecline}
                    className="flex-1 bg-white dark:bg-neutral-700 text-neutral-700 dark:text-neutral-200 border border-neutral-200 dark:border-neutral-600 px-4 py-2.5 rounded-lg hover:bg-neutral-50 dark:hover:bg-neutral-600 transition-colors duration-200 font-medium text-sm"
                >
                    Decline
                </button>
              </div>
              <button
                onClick={() => setShowSettings(true)}
                className="w-full text-indigo-600 dark:text-indigo-400 hover:text-indigo-700 dark:hover:text-indigo-300 text-sm font-medium transition-colors flex items-center justify-center gap-2 py-1"
              >
                <SafeIcon icon={FiSettings} className="w-4 h-4" />
                <span>Customize Preferences</span>
              </button>
            </div>

            <p className="mt-4 text-xs text-neutral-500 dark:text-neutral-500 text-center">
              By clicking "Accept All", you agree to our <Link href="/privacy-policy" className="underline hover:text-indigo-600">Privacy Policy</Link>.
            </p>
          </div>
        </motion.div>
      )}

      {/* Cookie Settings Modal */}
      {showSettings && (
        <motion.div
          initial={{ opacity: 0 }}
          animate={{ opacity: 1 }}
          exit={{ opacity: 0 }}
          className="fixed inset-0 bg-black/60 backdrop-blur-sm z-[10000] flex items-center justify-center p-4"
          onClick={() => setShowSettings(false)}
        >
          <motion.div
            initial={{ scale: 0.95, opacity: 0 }}
            animate={{ scale: 1, opacity: 1 }}
            exit={{ scale: 0.95, opacity: 0 }}
            className="bg-white dark:bg-neutral-800 rounded-2xl shadow-2xl max-w-md w-full p-6 border border-neutral-200 dark:border-neutral-700"
            onClick={(e) => e.stopPropagation()}
          >
            <div className="flex justify-between items-center mb-6 border-b border-neutral-100 dark:border-neutral-700 pb-4">
                <h3 className="text-xl font-bold text-neutral-900 dark:text-white">
                Preferences
                </h3>
                <button onClick={() => setShowSettings(false)} className="text-neutral-500 hover:text-neutral-900 dark:hover:text-white">
                    <SafeIcon icon={FiX} className="w-5 h-5" />
                </button>
            </div>
            
            <div className="space-y-4">
              {/* Essential Cookies */}
              <div className="flex items-center justify-between p-3 rounded-lg bg-neutral-50 dark:bg-neutral-700/30">
                <div>
                  <h4 className="font-semibold text-neutral-900 dark:text-white text-sm">Essential</h4>
                  <p className="text-xs text-neutral-500 dark:text-neutral-400 mt-0.5">
                    Required for site functionality.
                  </p>
                </div>
                <div className="w-10 h-5 bg-indigo-500/50 rounded-full relative cursor-not-allowed opacity-50">
                  <div className="w-4 h-4 bg-white rounded-full absolute top-0.5 right-0.5"></div>
                </div>
              </div>

              {/* Analytics Cookies */}
              <div className="flex items-center justify-between p-3 rounded-lg hover:bg-neutral-50 dark:hover:bg-neutral-700/30 transition-colors">
                <div>
                  <h4 className="font-semibold text-neutral-900 dark:text-white text-sm">Analytics</h4>
                  <p className="text-xs text-neutral-500 dark:text-neutral-400 mt-0.5">
                    Help us improve our website.
                  </p>
                </div>
                <button
                  onClick={() => handleTogglePreference('analytics')}
                  className={`w-10 h-5 rounded-full relative transition-colors duration-200 ${
                    cookiePreferences.analytics ? 'bg-indigo-600' : 'bg-neutral-300 dark:bg-neutral-600'
                  }`}
                >
                  <div
                    className={`w-4 h-4 bg-white rounded-full absolute top-0.5 transition-transform duration-200 ${
                      cookiePreferences.analytics ? 'right-0.5' : 'left-0.5'
                    }`}
                  ></div>
                </button>
              </div>

              {/* Marketing Cookies */}
              <div className="flex items-center justify-between p-3 rounded-lg hover:bg-neutral-50 dark:hover:bg-neutral-700/30 transition-colors">
                <div>
                  <h4 className="font-semibold text-neutral-900 dark:text-white text-sm">Marketing</h4>
                  <p className="text-xs text-neutral-500 dark:text-neutral-400 mt-0.5">
                    For personalized content.
                  </p>
                </div>
                <button
                  onClick={() => handleTogglePreference('marketing')}
                  className={`w-10 h-5 rounded-full relative transition-colors duration-200 ${
                    cookiePreferences.marketing ? 'bg-indigo-600' : 'bg-neutral-300 dark:bg-neutral-600'
                  }`}
                >
                  <div
                    className={`w-4 h-4 bg-white rounded-full absolute top-0.5 transition-transform duration-200 ${
                      cookiePreferences.marketing ? 'right-0.5' : 'left-0.5'
                    }`}
                  ></div>
                </button>
              </div>
            </div>

            <div className="flex gap-3 mt-8">
              <button
                onClick={handleSaveSettings}
                className="flex-1 bg-indigo-600 text-white px-4 py-2.5 rounded-xl hover:bg-indigo-700 transition-all font-bold text-sm shadow-md"
              >
                Save Preferences
              </button>
            </div>
          </motion.div>
        </motion.div>
      )}
    </AnimatePresence>
  );
};

export default CookieConsent;