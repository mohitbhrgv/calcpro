<?php
// --- Use PHPMailer classes ---
use PHPMailer\PHPMailer\PHPMailer;
use PHPMailer\PHPMailer\Exception;

// --- Composer's autoloader ---
require '../../vendor/autoload.php';

// --- Database & Email Configuration ---
require '../../core/config.php';

// Set content type to JSON
header('Content-Type: application/json');

// --- Get the request data ---
$json = file_get_contents('php://input');
$data = json_decode($json);

// --- Basic Validation ---
if (!isset($data->email) || !filter_var($data->email, FILTER_VALIDATE_EMAIL)) {
    echo json_encode(['success' => false, 'message' => 'A valid email is required.']);
    exit();
}

// --- Sanitize Input ---
$email = mysqli_real_escape_string($conn, trim($data->email));

// --- Check if user exists AND get their status ---
$sql = "SELECT id, name, status FROM users WHERE email = ?";
$stmt = $conn->prepare($sql);
$stmt->bind_param("s", $email);
$stmt->execute();
$result = $stmt->get_result();
$user = $result->fetch_assoc();
$stmt->close();

if (!$user) {
    echo json_encode(['success' => false, 'message' => 'No account found with that email address.']);
    $conn->close();
    exit();
}

if ($user['status'] === 'banned') {
    echo json_encode(['success' => false, 'message' => 'This account has been suspended and cannot be reset. Please contact support.']);
    $conn->close();
    exit();
}

try {
    // Generate a secure random token
    $token = bin2hex(random_bytes(32)); 
    $token_hash = hash('sha256', $token);
    $expiry_date = date('Y-m-d H:i:s', time() + 3600); // 1 Hour expiry

    // Update the existing user record with the token
    $update_sql = "UPDATE users SET reset_token = ?, reset_token_expires_at = ? WHERE id = ?";
    $update_stmt = $conn->prepare($update_sql);
    $update_stmt->bind_param("ssi", $token_hash, $expiry_date, $user['id']);
    $update_stmt->execute();
    $update_stmt->close();

    $mail = new PHPMailer(true);
    $mail->isSMTP();
    $mail->Host = $_ENV['SMTP_HOST'];
    $mail->SMTPAuth = true;
    $mail->Username = $_ENV['SMTP_USER'];
    $mail->Password = $_ENV['SMTP_PASS'];
    $mail->SMTPSecure = PHPMailer::ENCRYPTION_STARTTLS;
    $mail->Port = $_ENV['SMTP_PORT'];

    $mail->setFrom($_ENV['SMTP_FROM_EMAIL'], $_ENV['SMTP_FROM_NAME']);
    $mail->addAddress($email, $user['name']);

    $mail->isHTML(true);
    $mail->Subject = 'Password Reset Request for Calculox';
    
    // --- THE FIX: Correct URL Construction for Next.js ---
    // 1. Get the base URL (Default to localhost:3000 if ENV is missing)
    $frontendUrl = isset($_ENV['PUBLIC_FRONTEND_URL']) ? rtrim($_ENV['PUBLIC_FRONTEND_URL'], '/') : 'http://localhost:3000';
    
    // 2. Build the link WITHOUT the hash (#)
    $reset_link = $frontendUrl . "/reset-password/" . $token;

    $mail->Body    = "
        <div style='font-family: Arial, sans-serif; color: #333; max-width: 600px; margin: 0 auto;'>
            <h2 style='color: #2563EB;'>Password Reset Request</h2>
            <p>Hello {$user['name']},</p>
            <p>You requested a password reset for your account. Please click the button below to set a new password:</p>
            <p style='text-align: center; margin: 30px 0;'>
                <a href='{$reset_link}' style='display: inline-block; padding: 12px 24px; font-size: 16px; color: #ffffff; background-color: #2563EB; text-decoration: none; border-radius: 6px; font-weight: bold;'>
                    Reset Password
                </a>
            </p>
            <p>Or copy this link:</p>
            <p style='word-break: break-all;'><a href='{$reset_link}'>{$reset_link}</a></p>
            <hr style='border: 0; border-top: 1px solid #eee; margin: 20px 0;'>
            <p style='font-size: 12px; color: #888;'>This link is valid for 1 hour. If you did not request a password reset, please ignore this email.</p>
        </div>
    ";
    
    $mail->AltBody = "Hello {$user['name']},\n\nYou requested a password reset. Copy and paste this URL into your browser: {$reset_link}\n\nThis link is valid for 1 hour.";

    $mail->send();

    echo json_encode(['success' => true, 'message' => 'Password reset link has been sent to your email.']);

} catch (Exception $e) {
    error_log("PHPMailer Error: " . $mail->ErrorInfo);
    echo json_encode(['success' => false, 'message' => 'Failed to send reset email. Please try again later.']);
}

$conn->close();
?>