<?php
// Include the database configuration file, which has our validation function
require '../../core/config.php';

// Set content type to JSON
header('Content-Type: application/json');

// --- Get the request data ---
$json = file_get_contents('php://input');
$data = json_decode($json);

// --- Basic Validation ---
if (!isset($data->token) || !isset($data->password)) {
    echo json_encode(['success' => false, 'message' => 'Token and new password are required.']);
    exit();
}

// --- SERVER-SIDE PASSWORD STRENGTH VALIDATION ---
// Enforce the new password rules using our global function.
if (!validatePasswordStrength($data->password)) {
    // --- UPDATED: More descriptive error message ---
    echo json_encode(['success' => false, 'message' => 'Password must be at least 8 characters and contain a letter, a number, and a special character.']);
    exit();
}

// --- Sanitize Input ---
$token = $data->token;
$new_password = trim($data->password);

// --- Hash the received token to match the one in the database ---
$token_hash = hash('sha256', $token);

// --- 1. Find the user with this token hash and check if it's expired ---
$sql = "SELECT id, reset_token_expires_at FROM users WHERE reset_token = ?";
$stmt = $conn->prepare($sql);
$stmt->bind_param("s", $token_hash);
$stmt->execute();
$result = $stmt->get_result();
$user = $result->fetch_assoc();
$stmt->close();

// --- 2. Validate the token and user ---
if (!$user) {
    echo json_encode(['success' => false, 'message' => 'Invalid or expired reset token.']);
    $conn->close();
    exit();
}

// --- 3. Check if the token has expired ---
$expiry_time = strtotime($user['reset_token_expires_at']);
if ($expiry_time < time()) {
    echo json_encode(['success' => false, 'message' => 'Invalid or expired reset token.']);
    $conn->close();
    exit();
}

// --- 4. Token is valid. Hash the new password and update the database ---
$new_hashed_password = password_hash($new_password, PASSWORD_BCRYPT);

// We set the reset_token fields to NULL to invalidate the token after use.
$update_sql = "UPDATE users SET password = ?, reset_token = NULL, reset_token_expires_at = NULL WHERE id = ?";
$update_stmt = $conn->prepare($update_sql);
$update_stmt->bind_param("si", $new_hashed_password, $user['id']);

if ($update_stmt->execute()) {
    echo json_encode(['success' => true, 'message' => 'Password has been reset successfully. You can now log in.']);
} else {
    echo json_encode(['success' => false, 'message' => 'Failed to update password. Please try again.']);
}

// --- Close connections ---
$update_stmt->close();
$conn->close();

?>