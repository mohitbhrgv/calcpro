import React, { useState, useEffect, useCallback } from "react";
import { useLocation } from "react-router-dom"; // Integrated for 404 Monitor support
import { motion, AnimatePresence } from "framer-motion";
import SafeIcon from "../../../common/SafeIcon";
import * as FiIcons from "react-icons/fi";
import toast from "react-hot-toast";
import { authenticatedFetch } from "../../utils/apiService";
import LoadingSpinner from "../../components/common/LoadingSpinner";
import RedirectHelpModal from "../../components/help/RedirectHelpModal";
import Modal from "../../components/common/Modal";

const {
  FiPlus,
  FiTrash2,
  FiRefreshCw,
  FiLink,
  FiArrowRight,
  FiAlertCircle,
  FiCornerUpRight,
  FiInfo,
  FiGlobe,
  FiActivity,
  FiEdit2,
  FiSave,
  FiCheckCircle,
  FiPower,
} = FiIcons;

const ToggleSwitch = ({ checked, onChange }) => (
  <button
    type="button"
    role="switch"
    aria-checked={checked}
    onClick={onChange}
    className={`relative inline-flex items-center h-6 w-11 rounded-full transition-colors duration-200 ease-in-out focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 ${
      checked ? "bg-indigo-600" : "bg-gray-200 dark:bg-gray-600"
    }`}
  >
    <span
      className={`inline-block w-4 h-4 transform bg-white rounded-full transition-transform duration-200 ease-in-out ${
        checked ? "translate-x-6" : "translate-x-1"
      }`}
    />
  </button>
);

const SeoRedirects = () => {
  const location = useLocation(); // Hook to access state passed from 404 Monitor
  const [redirects, setRedirects] = useState([]);
  const [counts, setCounts] = useState({
    all: 0,
    active: 0,
    inactive: 0,
    trash: 0,
  });

  const [initialLoading, setInitialLoading] = useState(true);
  const [isUpdating, setIsUpdating] = useState(false);
  const [isSubmitting, setIsSubmitting] = useState(false);

  const [filterStatus, setFilterStatus] = useState("all");
  const [selectedIds, setSelectedIds] = useState([]);

  const [sourceInput, setSourceInput] = useState("");
  const [targetUrl, setTargetUrl] = useState("");
  const [statusCode, setStatusCode] = useState("301");

  const [isEditModalOpen, setIsEditModalOpen] = useState(false);
  const [editingRedirect, setEditingRedirect] = useState(null);

  const [isConfirmOpen, setIsConfirmOpen] = useState(false);
  const [confirmAction, setConfirmAction] = useState(null);

  const [isHelpOpen, setIsHelpOpen] = useState(false);

  const STATUS_OPTIONS = [
    { value: "301", label: "301 Permanent Move" },
    { value: "302", label: "302 Temporary Move" },
    { value: "307", label: "307 Temporary Redirect" },
    { value: "410", label: "410 Content Deleted" },
    { value: "451", label: "451 Unavailable (Legal)" },
  ];

  // --- 404 Monitor Integration: Auto-fill from state ---
  useEffect(() => {
    if (location.state && location.state.sourcePath) {
      // Clean leading slash if present to match system standard
      const cleanPath = location.state.sourcePath.replace(/^\/+/, "");
      setSourceInput(cleanPath);
      
      // Clear the history state so it doesn't re-fill if the user navigates back to this page later
      window.history.replaceState({}, document.title);
      
      toast.success("Imported URL from 404 Monitor", { id: 'import-toast' });
    }
  }, [location]);

  const fetchRedirects = useCallback(async () => {
    try {
      const result = await authenticatedFetch(
        `http://localhost/calcpro-api/api/admin/get_redirects.php?status=${filterStatus}`
      );
      if (result.success) {
        setRedirects(result.data.redirects);
        setCounts(result.data.counts);
      }
    } catch (error) {
      toast.error("Failed to load redirects.");
    }
  }, [filterStatus]);

  useEffect(() => {
    const loadData = async () => {
      if (initialLoading) {
        await fetchRedirects();
        setInitialLoading(false);
      } else {
        setIsUpdating(true);
        await fetchRedirects();
        setIsUpdating(false);
      }
    };
    loadData();
    setSelectedIds([]);
  }, [filterStatus, fetchRedirects]);

  const handleManualRefresh = async () => {
    setIsUpdating(true);
    await fetchRedirects();
    setTimeout(() => setIsUpdating(false), 500);
  };

  const handleAdd = async (e) => {
    e.preventDefault();
    
    // Prevent double submission
    if (isSubmitting) return;

    // Define a unique ID for validation errors to prevent toast stacking
    const toastId = "redirect-add-error";

    const isTargetRequired = !statusCode.startsWith("4");
    if (!sourceInput.trim()) {
      toast.error("Please enter the original source path.", { id: toastId });
      return;
    }
    if (isTargetRequired && !targetUrl.trim()) {
      toast.error("A destination URL is required for this redirect type.", { id: toastId });
      return;
    }
    
    const finalSourcePath = sourceInput.trim().replace(/^\/+/, "");
    setIsSubmitting(true);
    
    // Clear any existing error toasts
    toast.dismiss(toastId);

    try {
      const result = await authenticatedFetch(
        "http://localhost/calcpro-api/api/admin/add_redirect.php",
        {
          method: "POST",
          body: JSON.stringify({
            source_path: finalSourcePath,
            target_url: targetUrl,
            status_code: statusCode,
          }),
        }
      );
      if (result.success) {
        toast.success("Redirect rule created.");
        setSourceInput("");
        setTargetUrl("");
        setStatusCode("301");
        fetchRedirects();
      } else {
        toast.error(result.message);
      }
    } catch (error) {
      toast.error("Connection error.");
    } finally {
      setIsSubmitting(false);
    }
  };

  const openEditModal = (rule) => {
    setEditingRedirect({
      ...rule,
      source_path: rule.source_path,
      target_url: rule.target_url || "",
      status_code: rule.status_code.toString(),
    });
    setIsEditModalOpen(true);
  };

  const handleUpdate = async () => {
    if (!editingRedirect || isSubmitting) return;
    
    setIsSubmitting(true);
    try {
      const result = await authenticatedFetch(
        "http://localhost/calcpro-api/api/admin/update_redirect.php",
        {
          method: "POST",
          body: JSON.stringify(editingRedirect),
        }
      );
      if (result.success) {
        toast.success("Rule updated successfully.");
        setIsEditModalOpen(false);
        await fetchRedirects();
      } else {
        toast.error(result.message);
      }
    } catch (error) {
      toast.error("Connection error.");
    } finally {
      setIsSubmitting(false);
    }
  };

  const handleToggleStatus = async (rule) => {
    setIsUpdating(true);
    const newStatus = rule.status === "active" ? "inactive" : "active";
    try {
      await authenticatedFetch(
        "http://localhost/calcpro-api/api/admin/update_redirect.php",
        {
          method: "POST",
          body: JSON.stringify({ id: rule.id, status: newStatus }),
        }
      );
      await fetchRedirects();
    } catch (error) {
      toast.error("Failed to update status.");
    } finally {
      setIsUpdating(false);
    }
  };

  const openConfirmModal = (action) => {
    setConfirmAction(action);
    setIsConfirmOpen(true);
  };

  const getModalContent = () => {
    if (!confirmAction)
      return {
        title: "Confirm",
        message: "Are you sure?",
        button: "Confirm",
        color: "bg-blue-600 hover:bg-blue-700",
      };
    const type = confirmAction.type;
    const count = selectedIds.length;
    switch (type) {
      case "delete":
        return filterStatus === "trash"
          ? {
              title: "Delete Permanently?",
              message:
                "This rule will be deleted forever. This cannot be undone.",
              button: "Delete Forever",
              color: "bg-red-600 hover:bg-red-700",
            }
          : {
              title: "Move to Trash?",
              message:
                "The redirect will stop working. You can restore it later from the Trash tab.",
              button: "Move to Trash",
              color: "bg-red-600 hover:bg-red-700",
            };
      case "restore":
        return {
          title: "Restore Rule?",
          message: "This rule will be restored to Active status.",
          button: "Restore",
          color: "bg-blue-600 hover:bg-blue-700",
        };
      case "bulk_trash":
        return {
          title: `Trash ${count} Rules?`,
          message: `Move ${count} selected rules to the Trash?`,
          button: "Trash All",
          color: "bg-red-600 hover:bg-red-700",
        };
      case "bulk_delete_permanent":
        return {
          title: `Delete ${count} Rules?`,
          message: `Permanently delete ${count} rules? This cannot be undone.`,
          button: "Delete Forever",
          color: "bg-red-600 hover:bg-red-700",
        };
      case "bulk_restore":
        return {
          title: `Restore ${count} Rules?`,
          message: `Restore ${count} rules to Active status?`,
          button: "Restore All",
          color: "bg-blue-600 hover:bg-blue-700",
        };
      case "bulk_activate":
        return {
          title: "Activate Selected?",
          message: `Set ${count} rules to Active status?`,
          button: "Activate",
          color: "bg-green-600 hover:bg-green-700",
        };
      case "bulk_deactivate":
        return {
          title: "Deactivate Selected?",
          message: `Set ${count} rules to Inactive status?`,
          button: "Deactivate",
          color: "bg-amber-600 hover:bg-amber-700",
        };
      default:
        return {
          title: "Confirm Action",
          message: "Are you sure?",
          button: "Confirm",
          color: "bg-blue-600 hover:bg-blue-700",
        };
    }
  };

  const modalContent = getModalContent();

  const handleConfirm = () => {
    if (!confirmAction) return;
    const { type, rule } = confirmAction;
    if (type.startsWith("bulk_")) {
      handleBulkAction(type.replace("bulk_", ""));
    } else if (type === "restore") {
      handleRestore(rule);
    } else if (type === "delete") {
      handleDelete(rule);
    }
    setIsConfirmOpen(false);
    setConfirmAction(null);
  };

  const handleRestore = async (rule) => {
    try {
      const result = await authenticatedFetch(
        "http://localhost/calcpro-api/api/admin/restore_redirect.php",
        {
          method: "POST",
          body: JSON.stringify({ id: rule.id }),
        }
      );
      if (result.success) {
        toast.success("Rule restored.");
        fetchRedirects();
      } else {
        toast.error(result.message);
      }
    } catch (error) {
      toast.error("Restore failed.");
    }
  };

  const handleDeleteClick = (rule) => {
    openConfirmModal({ type: "delete", rule });
  };

  const handleDelete = async (rule) => {
    const isPermanent = filterStatus === "trash";
    const url = isPermanent
      ? "delete_permanent_redirect.php"
      : "delete_redirect.php";
    const successMsg = isPermanent
      ? "Rule permanently deleted."
      : "Rule moved to Trash.";
    try {
      const result = await authenticatedFetch(
        `http://localhost/calcpro-api/api/admin/${url}`,
        {
          method: "POST",
          body: JSON.stringify({ id: rule.id }),
        }
      );
      if (result.success) {
        toast.success(successMsg);
        fetchRedirects();
      } else {
        toast.error(result.message);
      }
    } catch (error) {
      toast.error("Failed to delete rule.");
    }
  };

  const handleBulkAction = async (action) => {
    if (selectedIds.length === 0) return;
    setIsUpdating(true);
    try {
      const result = await authenticatedFetch(
        "http://localhost/calcpro-api/api/admin/manage_redirects_bulk.php",
        {
          method: "POST",
          body: JSON.stringify({ ids: selectedIds, action: action }),
        }
      );
      if (result.success) {
        toast.success(result.message);
        await fetchRedirects();
      } else {
        toast.error(result.message);
      }
    } catch (error) {
      toast.error("Bulk action failed.");
    } finally {
      setIsUpdating(false);
    }
  };

  const handleSelectAll = (e) => {
    if (e.target.checked) {
      setSelectedIds(redirects.map((r) => r.id));
    } else {
      setSelectedIds([]);
    }
  };
  const handleSelectRow = (id) => {
    setSelectedIds((prev) =>
      prev.includes(id) ? prev.filter((i) => i !== id) : [...prev, id]
    );
  };

  const StatusBadge = ({ code }) => {
    const codeStr = String(code);
    const configs = {
      301: {
        bg: "bg-green-100 dark:bg-green-900/40",
        text: "text-green-700 dark:text-green-400",
        border: "border-green-200 dark:border-green-800",
        label: "301 Permanent",
      },
      302: {
        bg: "bg-amber-100 dark:bg-amber-900/40",
        text: "text-amber-700 dark:text-amber-400",
        border: "border-amber-200 dark:border-amber-800",
        label: "302 Temporary",
      },
      307: {
        bg: "bg-blue-100 dark:bg-blue-900/40",
        text: "text-blue-700 dark:text-blue-400",
        border: "border-blue-200 dark:border-blue-800",
        label: "307 Temporary",
      },
      410: {
        bg: "bg-red-100 dark:bg-red-900/40",
        text: "text-red-700 dark:text-red-400",
        border: "border-red-200 dark:border-red-800",
        label: "410 Gone",
      },
      451: {
        bg: "bg-gray-100 dark:bg-gray-700",
        text: "text-gray-700 dark:text-gray-300",
        border: "border-gray-200 dark:border-gray-600",
        label: "451 Legal",
      },
    };
    const c = configs[codeStr] || configs["301"];
    return (
      <span
        className={`inline-flex items-center px-2.5 py-0.5 rounded-md text-xs font-bold border ${c.bg} ${c.text} ${c.border}`}
      >
        {c.label}
      </span>
    );
  };

  if (initialLoading)
    return (
      <div className="h-64 flex items-center justify-center">
        <LoadingSpinner size="lg" />
      </div>
    );

  return (
    <div className="space-y-6">
      <RedirectHelpModal
        isOpen={isHelpOpen}
        onClose={() => setIsHelpOpen(false)}
        disableAnimation={true}
      />
      <Modal
        isOpen={isConfirmOpen}
        onClose={() => setIsConfirmOpen(false)}
        title={modalContent.title}
        type="default"
        size="sm"
        disableAnimation={true}
      >
        <div className="space-y-4">
          <p className="text-sm text-gray-600 dark:text-gray-300">
            {modalContent.message}
          </p>
          <div className="flex justify-end gap-2 pt-2">
            <button
              onClick={() => setIsConfirmOpen(false)}
              className="px-4 py-2 text-sm font-medium text-gray-600 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg"
            >
              Cancel
            </button>
            <button
              onClick={handleConfirm}
              className={`${modalContent.color} text-white px-4 py-2 text-sm font-bold rounded-lg transition-colors`}
            >
              {modalContent.button}
            </button>
          </div>
        </div>
      </Modal>
      {isEditModalOpen && editingRedirect && (
        <Modal
          isOpen={isEditModalOpen}
          onClose={() => setIsEditModalOpen(false)}
          title="Edit Redirect Rule"
          size="lg"
          disableAnimation={true}
        >
          <div className="space-y-5">
            <div>
              <label className="block text-xs font-bold text-gray-600 dark:text-gray-400 uppercase mb-1">
                Source Path
              </label>
              <div className="flex rounded-lg shadow-sm border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 overflow-hidden">
                <span className="px-3 py-2 bg-gray-100 dark:bg-gray-800 text-gray-500 dark:text-gray-400 text-sm border-r border-gray-300 dark:border-gray-600 flex items-center">
                  https://calcpro.com/
                </span>
                <input
                  type="text"
                  value={editingRedirect.source_path}
                  onChange={(e) =>
                    setEditingRedirect((p) => ({
                      ...p,
                      source_path: e.target.value,
                    }))
                  }
                  className="flex-1 px-3 py-2 bg-transparent dark:text-white outline-none"
                />
              </div>
            </div>
            <div>
              <label className="block text-xs font-bold text-gray-600 dark:text-gray-400 uppercase mb-1">
                Action Type
              </label>
              <select
                value={editingRedirect.status_code}
                onChange={(e) =>
                  setEditingRedirect((p) => ({
                    ...p,
                    status_code: e.target.value,
                  }))
                }
                className="w-full px-3 py-2 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 dark:text-white outline-none focus:ring-2 focus:ring-indigo-500"
              >
                {STATUS_OPTIONS.map((opt) => (
                  <option key={opt.value} value={opt.value}>
                    {opt.label}
                  </option>
                ))}
              </select>
            </div>
            <div
              className={
                String(editingRedirect.status_code).startsWith("4")
                  ? "opacity-50 pointer-events-none"
                  : ""
              }
            >
              <label className="block text-xs font-bold text-gray-600 dark:text-gray-400 uppercase mb-1">
                Target Destination
              </label>
              <input
                type="text"
                value={editingRedirect.target_url}
                onChange={(e) =>
                  setEditingRedirect((p) => ({
                    ...p,
                    target_url: e.target.value,
                  }))
                }
                placeholder="https://..."
                className="w-full px-3 py-2 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 dark:text-white outline-none focus:ring-2 focus:ring-indigo-500"
              />
            </div>
            <div className="flex justify-end gap-2 pt-3">
              <button
                onClick={() => setIsEditModalOpen(false)}
                className="px-4 py-2 text-sm font-medium text-gray-600 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg transition-colors"
              >
                Cancel
              </button>
              <button
                onClick={handleUpdate}
                disabled={isSubmitting}
                className="flex items-center gap-2 px-5 py-2 text-sm font-bold text-white bg-indigo-600 hover:bg-indigo-700 rounded-lg transition-colors shadow-sm disabled:opacity-50"
              >
                {isSubmitting ? (
                  "Updating..."
                ) : (
                  <>
                    <SafeIcon icon={FiSave} className="w-4 h-4" /> Update Rule
                  </>
                )}
              </button>
            </div>
          </div>
        </Modal>
      )}
      
      <div className="flex items-start gap-4 p-4 rounded-lg bg-indigo-50 dark:bg-indigo-900/20 border border-indigo-100 dark:border-indigo-800/50">
        <div className="p-2 bg-indigo-100 dark:bg-indigo-800 rounded-lg text-indigo-600 dark:text-indigo-300 shrink-0">
          <SafeIcon icon={FiCornerUpRight} className="w-5 h-5" />
        </div>
        <div>
          <div className="flex items-center gap-2">
              <h4 className="font-bold text-gray-900 dark:text-white">Redirection Manager</h4>
              <button
                onClick={() => setIsHelpOpen(true)}
                className="text-gray-400 hover:text-indigo-600 dark:hover:text-indigo-400 transition-colors p-1 rounded-full hover:bg-indigo-50 dark:hover:bg-indigo-900/30"
                title="Redirection Guidelines"
              >
                <SafeIcon icon={FiInfo} className="w-4 h-4" />
              </button>
          </div>
          <p className="text-sm text-gray-600 dark:text-gray-300 mt-1 leading-relaxed">
            Manage server-side rules to handle moved or deleted content, preserving SEO equity and improving user experience.
          </p>
        </div>
      </div>
      
      <div className="space-y-8">
          <div className="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 overflow-hidden">
            <div className="px-6 py-4 border-b border-gray-200 dark:border-gray-700 bg-gray-50/50 dark:bg-gray-800/50">
              <h3 className="text-sm font-bold text-gray-900 dark:text-white flex items-center gap-2 uppercase tracking-wider">
                <SafeIcon icon={FiPlus} className="w-4 h-4 text-indigo-500" />
                Create New Redirect Rule
              </h3>
            </div>
            <div className="p-6">
              <form onSubmit={handleAdd} className="space-y-6">
                <div className="grid grid-cols-1 gap-6">
                  <div className="space-y-1.5">
                    <label className="block text-xs font-bold text-gray-600 dark:text-gray-400 uppercase tracking-wide">
                      Original Source URL
                    </label>
                    <div className="flex rounded-lg shadow-sm ring-1 ring-gray-300 dark:ring-gray-600 focus-within:ring-2 focus-within:ring-indigo-500 bg-white dark:bg-gray-900 overflow-hidden transition-shadow">
                      <div className="relative flex items-center px-3 bg-gray-100 dark:bg-gray-800 border-r border-gray-300 dark:border-gray-600 text-gray-500 dark:text-gray-400 text-sm font-mono select-none">
                        <span>https://calcpro.com/</span>
                      </div>
                      <input
                        type="text"
                        value={sourceInput}
                        onChange={(e) => setSourceInput(e.target.value)}
                        placeholder="old-page-slug"
                        className="flex-1 block min-w-0 border-none bg-transparent py-2.5 px-3 text-gray-900 dark:text-white placeholder:text-gray-400 focus:ring-0 sm:text-sm font-mono"
                      />
                    </div>
                    <p className="text-[11px] text-gray-500 dark:text-gray-400 mt-1">
                      Enter the relative path (slug) of the old content.
                      Example: <code>about-us</code> or{" "}
                      <code>blog/old-post</code>.
                    </p>
                  </div>
                  <div className="space-y-1.5">
                    <label className="block text-xs font-bold text-gray-600 dark:text-gray-400 uppercase tracking-wide">
                      Action Type
                    </label>
                    <div className="flex flex-wrap gap-2">
                      {STATUS_OPTIONS.map((option) => (
                        <label
                          key={option.value}
                          className={`relative cursor-pointer select-none py-2 px-4 rounded-md border text-sm font-medium transition-all ${statusCode === option.value ? "bg-indigo-600 text-white border-indigo-600 shadow-sm ring-2 ring-offset-1 ring-indigo-500 dark:ring-offset-gray-800" : "bg-white dark:bg-gray-700 text-gray-700 dark:text-gray-200 border-gray-300 dark:border-gray-600 hover:bg-gray-50 dark:hover:bg-gray-600"}`}
                        >
                          <input
                            type="radio"
                            name="status_code"
                            value={option.value}
                            checked={statusCode === option.value}
                            onChange={(e) => setStatusCode(e.target.value)}
                            className="sr-only"
                          />
                          {option.label}
                        </label>
                      ))}
                    </div>
                  </div>
                  <div className="space-y-1.5">
                    <label className="block text-xs font-bold text-gray-600 dark:text-gray-400 uppercase tracking-wide">
                      Target Destination
                    </label>
                    <div className="flex gap-3">
                      <div className="relative flex-1">
                        <div className="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none text-gray-400">
                          <SafeIcon icon={FiLink} className="h-4 w-4" />
                        </div>
                        <input
                          type="text"
                          value={targetUrl}
                          onChange={(e) => setTargetUrl(e.target.value)}
                          placeholder={
                            statusCode.startsWith("4")
                              ? "(Not applicable for this action type)"
                              : "https://..."
                          }
                          disabled={statusCode.startsWith("4")}
                          className={`block w-full rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-900 py-2.5 pl-10 pr-3 text-gray-900 dark:text-white shadow-sm focus:border-indigo-500 focus:ring-2 focus:ring-indigo-500 sm:text-sm outline-none transition-opacity ${statusCode.startsWith("4") ? "opacity-50 cursor-not-allowed bg-gray-50" : ""}`}
                        />
                      </div>
                      <button
                        type="submit"
                        disabled={isSubmitting}
                        className="inline-flex items-center justify-center rounded-lg border border-transparent bg-indigo-600 px-6 text-sm font-bold text-white shadow-sm hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 disabled:opacity-50 transition-all min-w-[140px]"
                      >
                        {isSubmitting ? (
                          <LoadingSpinner
                            size="xs"
                            className="w-5 h-5 text-white"
                            color="white"
                          />
                        ) : (
                          "Add Rule"
                        )}
                      </button>
                    </div>
                    <p className="text-[11px] text-gray-500 dark:text-gray-400 mt-1">
                      Enter the full absolute URL (e.g.,{" "}
                      <code>https://google.com</code>) or a relative path (e.g.,{" "}
                      <code>/contact</code>) you want to redirect to.
                    </p>
                  </div>
                </div>
              </form>
            </div>
          </div>
          
          <div className="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 overflow-hidden">
            <div className="bg-gray-50 dark:bg-gray-700/50 px-6 py-3 border-b border-gray-200 dark:border-gray-700 flex justify-between items-center min-h-[58px]">
              <div className="flex items-center gap-4">
                {["all", "active", "inactive", "trash"].map((status) => (
                  <button
                    key={status}
                    onClick={() => setFilterStatus(status)}
                    className={`py-1 px-3 text-sm font-medium rounded-md transition-colors ${filterStatus === status ? "bg-indigo-100 text-indigo-700 dark:bg-indigo-900/30 dark:text-indigo-400" : "text-gray-500 hover:text-gray-700"}`}
                  >
                    {status.charAt(0).toUpperCase() + status.slice(1)}{" "}
                    <span className="ml-1 text-xs bg-gray-200 dark:bg-gray-600 px-1.5 py-0.5 rounded-full font-bold">
                      {counts[status]}
                    </span>
                  </button>
                ))}
              </div>
              <div className="flex items-center gap-2">
                <AnimatePresence>
                  {selectedIds.length > 0 && (
                    <motion.div
                      key="actions"
                      initial={{ opacity: 0, x: 10 }}
                      animate={{ opacity: 1, x: 0 }}
                      exit={{ opacity: 0, x: 10 }}
                      className="flex items-center gap-2"
                    >
                      <span className="text-sm font-semibold text-indigo-800 dark:text-indigo-200">
                        {selectedIds.length} items selected
                      </span>
                      <div className="h-4 w-px bg-gray-300 dark:bg-gray-600"></div>
                      <div className="flex gap-2">
                        {filterStatus !== "trash" && (
                          <>
                            <button
                              onClick={() =>
                                openConfirmModal({ type: "bulk_activate" })
                              }
                              className="text-xs font-bold flex items-center gap-1.5 text-green-600 hover:text-green-800 bg-green-50 dark:bg-green-900/20 border border-green-200 dark:border-green-800/50 px-2 py-1 rounded-md transition-colors shadow-sm"
                            >
                              <SafeIcon
                                icon={FiCheckCircle}
                                className="w-3.5 h-3.5"
                              />
                              Activate
                            </button>
                            <button
                              onClick={() =>
                                openConfirmModal({ type: "bulk_deactivate" })
                              }
                              className="text-xs font-bold flex items-center gap-1.5 text-amber-600 hover:text-amber-800 bg-amber-50 dark:bg-amber-900/20 border border-amber-200 dark:border-amber-800/50 px-2 py-1 rounded-md transition-colors shadow-sm"
                            >
                              <SafeIcon
                                icon={FiPower}
                                className="w-3.5 h-3.5"
                              />
                              Deactivate
                            </button>
                            <button
                              onClick={() =>
                                openConfirmModal({ type: "bulk_trash" })
                              }
                              className="text-xs font-bold flex items-center gap-1.5 text-red-600 hover:text-red-800 bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800/50 px-2 py-1 rounded-md transition-colors shadow-sm"
                            >
                              <SafeIcon
                                icon={FiTrash2}
                                className="w-3.5 h-3.5"
                              />
                              Trash
                            </button>
                          </>
                        )}
                        {filterStatus === "trash" && (
                          <>
                            <button
                              onClick={() =>
                                openConfirmModal({ type: "bulk_restore" })
                              }
                              className="text-xs font-bold flex items-center gap-1.5 text-blue-600 hover:text-blue-800 bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800/50 px-2 py-1 rounded-md transition-colors shadow-sm"
                            >
                              <SafeIcon
                                icon={FiRefreshCw}
                                className="w-3.5 h-3.5"
                              />
                              Restore
                            </button>
                            <button
                              onClick={() =>
                                openConfirmModal({
                                  type: "bulk_delete_permanent",
                                })
                              }
                              className="text-xs font-bold flex items-center gap-1.5 text-red-600 hover:text-red-800 bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800/50 px-2 py-1 rounded-md transition-colors shadow-sm"
                            >
                              <SafeIcon
                                icon={FiTrash2}
                                className="w-3.5 h-3.5"
                              />
                              Delete Forever
                            </button>
                          </>
                        )}
                      </div>
                    </motion.div>
                  )}
                </AnimatePresence>
                <button
                  onClick={handleManualRefresh}
                  className="p-1.5 text-gray-400 hover:text-indigo-600 hover:bg-indigo-50 dark:hover:bg-indigo-900/20 rounded-lg transition-colors"
                  title="Refresh List"
                >
                  <SafeIcon
                    icon={FiRefreshCw}
                    className={`w-4 h-4 ${isUpdating ? "animate-spin text-indigo-600" : ""}`}
                  />
                </button>
              </div>
            </div>

            <div
              className={`overflow-x-auto relative ${isUpdating ? "opacity-50 pointer-events-none" : ""}`}
            >
              <AnimatePresence>
                {isUpdating && (
                  <motion.div
                    initial={{ opacity: 0 }}
                    animate={{ opacity: 1 }}
                    exit={{ opacity: 0 }}
                    className="absolute inset-0 bg-white/50 dark:bg-gray-800/50 flex items-center justify-center z-10"
                  >
                    <LoadingSpinner />
                  </motion.div>
                )}
              </AnimatePresence>
              <table className="w-full text-left border-collapse">
                <thead className="bg-gray-50 dark:bg-gray-800/80 border-b border-gray-200 dark:border-gray-700">
                  <tr>
                    <th className="px-4 py-4 w-12">
                      <input
                        type="checkbox"
                        onChange={handleSelectAll}
                        checked={
                          redirects.length > 0 &&
                          selectedIds.length === redirects.length
                        }
                        className="rounded border-gray-300 text-indigo-600 focus:ring-indigo-500"
                      />
                    </th>
                    <th className="px-6 py-4 text-xs font-bold text-gray-500 dark:text-gray-400 uppercase tracking-wider w-32">
                      Type
                    </th>
                    <th className="px-6 py-4 text-xs font-bold text-gray-500 dark:text-gray-400 uppercase tracking-wider">
                      Source URL
                    </th>
                    <th className="px-2 py-4 w-8"></th>
                    <th className="px-6 py-4 text-xs font-bold text-gray-500 dark:text-gray-400 uppercase tracking-wider">
                      Destination
                    </th>
                    {filterStatus !== "trash" && (
                      <th className="px-6 py-4 text-xs font-bold text-gray-500 dark:text-gray-400 uppercase tracking-wider text-center w-24">
                        State
                      </th>
                    )}
                    <th className="px-6 py-4 text-xs font-bold text-gray-500 dark:text-gray-400 uppercase tracking-wider text-right w-32">
                      Actions
                    </th>
                  </tr>
                </thead>
                <tbody className="divide-y divide-gray-100 dark:divide-gray-700/50">
                  {redirects.length === 0 ? (
                    <tr>
                      <td colSpan="7" className="px-6 py-16 text-center">
                        <div className="flex flex-col items-center opacity-50">
                          <SafeIcon
                            icon={FiActivity}
                            className="w-12 h-12 text-gray-300 mb-3"
                          />
                          <p className="text-gray-500 font-medium">
                            No rules in this view.
                          </p>
                        </div>
                      </td>
                    </tr>
                  ) : (
                    redirects.map((rule) => (
                      <tr
                        key={rule.id}
                        className={`group transition-colors ${selectedIds.includes(rule.id) ? "bg-indigo-50 dark:bg-indigo-900/10" : "hover:bg-gray-50 dark:hover:bg-gray-700/20"}`}
                      >
                        <td className="px-4 py-3 align-middle">
                          <input
                            type="checkbox"
                            checked={selectedIds.includes(rule.id)}
                            onChange={() => handleSelectRow(rule.id)}
                            className="rounded border-gray-300 text-indigo-600 focus:ring-indigo-500"
                          />
                        </td>
                        <td className="px-6 py-3 whitespace-nowrap align-middle">
                          <StatusBadge code={rule.status_code} />
                        </td>
                        <td className="px-6 py-3 align-middle max-w-[260px]">
                          <div
                            className="font-mono text-sm text-gray-700 dark:text-gray-300 truncate"
                            title={rule.source_path}
                          >
                            <span className="text-gray-400 select-none">/</span>
                            {rule.source_path}
                          </div>
                        </td>
                        <td className="px-2 py-3 text-center align-middle">
                          <SafeIcon
                            icon={FiArrowRight}
                            className="w-4 h-4 text-gray-300 dark:text-gray-600"
                          />
                        </td>
                        <td className="px-6 py-3 align-middle max-w-[300px]">
                          {String(rule.status_code).startsWith("4") ? (
                            <span className="text-sm text-red-500/80 font-medium italic flex items-center gap-1.5">
                              <SafeIcon
                                icon={FiAlertCircle}
                                className="w-3.5 h-3.5"
                              />{" "}
                              No Destination
                            </span>
                          ) : (
                            <a
                              href={rule.target_url}
                              target="_blank"
                              rel="noopener noreferrer"
                              className="text-sm text-blue-600 dark:text-blue-400 hover:underline font-medium flex items-center gap-1.5 group/link truncate"
                              title={rule.target_url}
                            >
                              <SafeIcon
                                icon={FiGlobe}
                                className="w-3.5 h-3.5 opacity-70 group-hover/link:opacity-100"
                              />
                              <span className="truncate">
                                {rule.target_url}
                              </span>
                            </a>
                          )}
                        </td>

                        {filterStatus !== "trash" && (
                          <td className="px-6 py-3 whitespace-nowrap text-center align-middle">
                            <ToggleSwitch
                              checked={rule.status === "active"}
                              onChange={() => handleToggleStatus(rule)}
                            />
                          </td>
                        )}

                        <td className="px-6 py-3 whitespace-nowrap text-right align-middle">
                          <div className="flex items-center justify-end gap-2">
                            {filterStatus === "trash" ? (
                              <button
                                onClick={() =>
                                  openConfirmModal({ type: "restore", rule })
                                }
                                className="p-2 text-gray-400 hover:text-blue-600 rounded-lg"
                                title="Restore Rule"
                              >
                                <SafeIcon
                                  icon={FiRefreshCw}
                                  className="w-4 h-4"
                                />
                              </button>
                            ) : (
                              <button
                                onClick={() => openEditModal(rule)}
                                className="p-2 text-gray-400 hover:text-blue-600 rounded-lg"
                                title="Edit Rule"
                              >
                                <SafeIcon icon={FiEdit2} className="w-4 h-4" />
                              </button>
                            )}
                            <button
                              onClick={() => handleDeleteClick(rule)}
                              className="p-2 text-gray-400 hover:text-red-600 rounded-lg"
                              title={
                                filterStatus === "trash"
                                  ? "Delete Permanently"
                                  : "Move to Trash"
                              }
                            >
                              <SafeIcon icon={FiTrash2} className="w-4 h-4" />
                            </button>
                          </div>
                        </td>
                      </tr>
                    ))
                  )}
                </tbody>
              </table>
            </div>
          </div>
        </div>
    </div>
  );
};

export default SeoRedirects;