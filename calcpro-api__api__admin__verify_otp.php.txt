<?php
// Use the JWT classes
use Firebase\JWT\JWT;

// Core utilities
require '../../core/config.php';
require_once '../../core/response.php';
require_once '../../core/SecurityGuard.php'; 
require_once '../../vendor/autoload.php';

// --- 1. Get IP Address and Input Data ---
$ip_address = $_SERVER['REMOTE_ADDR'];
$user_agent = $_SERVER['HTTP_USER_AGENT'] ?? 'unknown';
$ua_hash = hash('sha256', $user_agent);

$json = file_get_contents('php://input');
$data = json_decode($json);

// --- 2. Basic Validation ---
if (!isset($data->email) || !filter_var(trim($data->email), FILTER_VALIDATE_EMAIL)) {
    sendResponse(false, null, 'A valid email address is required.', 400, 'INVALID_INPUT');
}
if (!isset($data->otp_code) || !preg_match('/^\d{6}$/', $data->otp_code)) {
    sendResponse(false, null, 'A valid 6-digit OTP code is required.', 400, 'INVALID_INPUT');
}

$email = trim($data->email);
$otp_code = $data->otp_code;

// --- 3. Security Check (Pre-Flight) ---
$guard = new SecurityGuard($conn, $ip_address);
$securityStatus = $guard->checkIpStatus();

if (!$securityStatus['allowed']) {
    sendResponse(false, null, $securityStatus['message'], 403, $securityStatus['code']);
}

try {
    // --- 4. Find the Admin and the Pending OTP ---
    $sql = "
        SELECT 
            a.id, a.name, a.email, a.role, 
            otp.otp_code_hash
        FROM admins a
        JOIN admin_otp_verifications otp ON a.id = otp.admin_id
        WHERE a.email = ? AND otp.expires_at > NOW()
        ORDER BY otp.created_at DESC
        LIMIT 1
    ";
    
    $stmt = $conn->prepare($sql);
    $stmt->bind_param("s", $email);
    $stmt->execute();
    $result = $stmt->get_result();

    if ($result->num_rows === 0) {
        $stmt->close();
        // Log as 'otp_unknown' or 'email' since we couldn't find a pending record
        $guard->logFailure($email, null, 'email');
        
        $newStatus = $guard->checkIpStatus();
        if (!$newStatus['allowed']) {
             sendResponse(false, null, $newStatus['message'], 429, $newStatus['code']);
        }
        sendResponse(false, null, 'Invalid OTP, or it has expired. Please try logging in again.', 401, 'OTP_INVALID_OR_EXPIRED');
    }
    
    $admin_data = $result->fetch_assoc();
    $stmt->close();

    // --- 5. Verify the OTP Hash ---
    if (!password_verify($otp_code, $admin_data['otp_code_hash'])) {
        // --- UPDATED: Log specifically as an OTP failure ---
        $guard->logFailure($email, $admin_data['id'], 'otp');
        
        $newStatus = $guard->checkIpStatus();
        if (!$newStatus['allowed']) {
            // Generate Unblock Token if this failure triggered a block
            $unblock_token = bin2hex(random_bytes(32));
            $unblock_token_hash = hash('sha256', $unblock_token);
            $unblock_expiry = date('Y-m-d H:i:s', time() + 3600);

            $insert_token_stmt = $conn->prepare("INSERT INTO admin_unblock_tokens (admin_id, ip_address_blocked, token_hash, expires_at) VALUES (?, ?, ?, ?)");
            $insert_token_stmt->bind_param("isss", $admin_data['id'], $ip_address, $unblock_token_hash, $unblock_expiry);
            
            if ($insert_token_stmt->execute()) {
                $unlock_link = rtrim($_ENV['ADMIN_FRONTEND_URL'], '/') . "/#/admin/unlock-account/" . $unblock_token;
                $subject = 'Account Access Alert & Recovery Link';
                $htmlBody = "<p>Hello {$admin_data['name']},</p><p>Multiple failed OTP attempts were detected from your IP address: <strong>{$ip_address}</strong>.</p><p>As a security measure, this IP has been temporarily blocked.</p><p>If this was you, click the link below to verify your identity and unblock your IP immediately:</p><p><a href='{$unlock_link}'>Unblock My IP Address</a></p>";
                $altBody = "Unlock Link: {$unlock_link}";
                sendSecurityEmail($admin_data['email'], $admin_data['name'], $subject, $htmlBody, $altBody);
            }
            $insert_token_stmt->close();
            sendResponse(false, null, $newStatus['message'], 429, $newStatus['code']);
        }
        sendResponse(false, null, 'Invalid OTP. Please try again.', 401, 'OTP_INVALID');
    }

    // --- 6. OTP is VALID - Finalize Login ---
    $conn->begin_transaction();
    try {
        // a) Record Trust
        $insert_trust_stmt = $conn->prepare("
            INSERT INTO admin_trusted_devices (admin_id, ip_address, user_agent_hash, last_verified_at) 
            VALUES (?, ?, ?, NOW()) 
            ON DUPLICATE KEY UPDATE last_verified_at = NOW()
        ");
        $insert_trust_stmt->bind_param("iss", $admin_data['id'], $ip_address, $ua_hash);
        $insert_trust_stmt->execute();
        $insert_trust_stmt->close();

        // b) Clean up OTP
        $delete_otp_stmt = $conn->prepare("DELETE FROM admin_otp_verifications WHERE admin_id = ?");
        $delete_otp_stmt->bind_param("i", $admin_data['id']);
        $delete_otp_stmt->execute();
        $delete_otp_stmt->close();

        // c) Issue JWT
        $jwtSecretKey = $_ENV['JWT_SECRET'];
        $payload = [
            'iat' => time(), 
            'iss' => $_SERVER['SERVER_NAME'], 
            'exp' => time() + 86400, // 24 Hours
            'data' => ['adminId' => $admin_data['id'], 'adminRole' => $admin_data['role']]
        ];

        $jwt = JWT::encode($payload, $jwtSecretKey, 'HS256');

        // d) Update login time
        $update_login_stmt = $conn->prepare("UPDATE admins SET last_login = NOW() WHERE id = ?");
        $update_login_stmt->bind_param("i", $admin_data['id']);
        $update_login_stmt->execute();
        $update_login_stmt->close();

        // e) Clear failure logs (Reset counters)
        $conn->query("DELETE FROM login_attempts WHERE ip_address = '{$ip_address}'");
        $conn->query("DELETE FROM admin_login_failures WHERE ip_address = '{$ip_address}'");
        
        $conn->commit();
    } catch (Exception $e) {
        $conn->rollback();
        throw $e;
    }

    $responseData = [
        'user' => [
            'id' => $admin_data['id'], 
            'name' => $admin_data['name'], 
            'email' => $admin_data['email'], 
            'role' => $admin_data['role']
        ], 
        'token' => $jwt
    ];
    sendResponse(true, $responseData, 'Verification successful. Welcome back!', 200);

} catch (Exception $e) {
    error_log("Error in verify_otp.php: " . $e->getMessage());
    sendResponse(false, null, 'An internal server error occurred during OTP verification.', 500, 'SERVER_ERROR');
}

$conn->close();
?>